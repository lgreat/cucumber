<?xml version="1.0" encoding="UTF-8"?>
<jsp:root version="2.0"
          xmlns:jsp="http://java.sun.com/JSP/Page"
          xmlns:c="http://java.sun.com/jsp/jstl/core"
          xmlns:fn="http://java.sun.com/jsp/jstl/functions"
          xmlns:gsml="urn:jsptagdir:/WEB-INF/tags/gsml"
          xmlns:pageHelper="urn:jsptagdir:/WEB-INF/tags/pageHelper"
          xmlns:link="urn:www.greatschools.org/taglib/link"
          xmlns:fmt="http://java.sun.com/jsp/jstl/fmt"
          xmlns:community="urn:jsptagdir:/WEB-INF/tags/community"
          xmlns:gsweb="gstaglib">
    <c:if test="${!empty requestScope.discussionBoard and !empty requestScope.discussions}">
        <script type="text/javascript">
            jQuery(function() {
                jQuery(".startADiscussion").click(function(event) {
                    return checkLogin();
                });
            });

            //<c:if test="${requestScope.context.user eq null}">
                function checkLogin() {
                    document.location='${loginRedirectUrl}';
                    return false;
                }
            //</c:if>
            //<c:if test="${requestScope.context.user ne null}">
                function checkLogin() {
                    return true;
                }
            //</c:if>

            function getLocalDiscussionTitle() {
                var title = jQuery('#localDiscussionsTitleBox').val();
                if (title != 'Ask your community and get an answer') {
                    return encodeURIComponent(title);
                }
                return '';
            }
        </script>

        <!--<p>requestScope.style = <c:out value="${requestScope.style}" default="don't know"/></p>-->
        <!--<p>requestScope.showForm = <c:out value="${requestScope.showForm}" default="don't know"/></p>-->
        
        <c:choose>
            <c:when test="${requestScope.style eq 'communityLanding'}">
            </c:when>
            <c:otherwise>
                <pageHelper:externalCss file="/res/css/discussionBoards/db_community.css"/>
                <pageHelper:externalCss file="/res/css/content/db_tc_hover.css"/>
            </c:otherwise>
        </c:choose>

        <c:set var="fullUri" value="${requestScope.discussionBoard.fullUri}"/>

        <div id="recentDiscussions" class="clearfix">

            <p class="text1">
                <c:choose>
                    <c:when test="${requestScope.style eq 'communityLanding'}">
                        Conversations about <span class="text1bold-d61">${requestScope.cityName}</span>
                        <div class="spacer_10"><!-- do not collapse --></div>
                        <c:import url="/community/changeLocalBoards.module"/>
                        <c:set var="resultsWidth" value="results"/>
                    </c:when>
                    <c:otherwise>
                        ${requestScope.discussionBoard.title}
                        <c:set var="resultsWidth" value="cityresults"/>
                    </c:otherwise>
                </c:choose>
            </p>
            <div class="spacer_10"><!-- do not collapse --></div>
            <ul>
            <c:forEach var="discussion" items="${requestScope.discussions}">

                <li class="clearfix">
                <div class="sprite discussion fltlft mrgtop_5 mrgrt_10"><!-- do not collapse --></div>

                <div class="${resultsWidth} fltlft">
                    <p class="text3bold">
                    <link:discussion discussionId="${discussion.id}"
                                     fullUri="${fullUri}">${discussion.title}</link:discussion>
                </p>

                <p>
                    <community:userContentTeaserText
                            textToDisplay="${discussion.body}"
                            minLength="45" maxLength="55"
                            discussionId="${discussion.id}"
                            discussionFullUri="${fullUri}"
                            numReplies="${discussion.totalReplies}"
                            textSpanClass="smallAlertText"/>
                </p>
                    </div>
                </li>

            </c:forEach>
            </ul>

            <p class="fltrt smallAlertText"><link:cmsContent contentKey="${requestScope.discussionBoard.contentKey}"
                                              fullUri="${fullUri}">More conversations <span class="alertDoubleArrow">&amp;raquo;</span></link:cmsContent></p>

            <c:if test="${requestScope.showForm}">
                <br class="clearfloat"/>
                <hr class="hr"/>
                <h2>Got a question about ${cityName}?</h2>
                <textarea id="localDiscussionsTitleBox"
                          class="textarea"
                          onclick="GS_textSwitch(this, '', 'Ask your community and get an answer'); checkLogin();"
                          onblur="GS_textSwitch(this, 'Ask your community and get an answer', '');">Ask your community and get an answer</textarea>

                <div class="fltlft">
                    <a href="javascript:void(0);" class="button-1 jqRecentLocalDiscussions_startADiscussion" onclick="this.blur(); return false;"><span class="sprite community fltlft mrgtop_2 mrgrt_5"><!-- icon --></span>Post conversation</a>

                    <community:startADiscussionHover loginRedirectUrl="${requestScope.loginRedirectUrl}"
                                                     openElementJQuerySelector=".jqRecentLocalDiscussions_startADiscussion"
                                                     topicCenterId="${requestScope.discussionBoard.topicCenterId}"
                                                     discussionBoardId="${requestScope.discussionBoard.contentKey.identifier}"
                                                     getTitleFunc="getLocalDiscussionTitle()"/>
                </div>
                <!-- end start a discussion button -->
            </c:if>
        </div>
        <!-- end recentDiscussions -->

    </c:if>
</jsp:root>