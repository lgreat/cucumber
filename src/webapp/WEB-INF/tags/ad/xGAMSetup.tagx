<?xml version="1.0" encoding="UTF-8"?>
<jsp:root version="2.0"
          xmlns:jsp="http://java.sun.com/JSP/Page"
          xmlns:c="http://java.sun.com/jsp/jstl/core"
          xmlns:fn="http://java.sun.com/jsp/jstl/functions"
          xmlns:gsweb="gstaglib">
    <jsp:directive.attribute name="hideDefaultAds" type="java.lang.Boolean" required="false"/>
    <jsp:directive.tag body-content="empty"
                       description="Generates necessary JavaScript to show the ads on a page. Generally you will not call this directly, but it will be called by the page decorator."/>
    <jsp:directive.tag import="gs.web.ads.AdPosition"/>
    <jsp:directive.tag import="gs.web.ads.AdTagHandler"/>
    <jsp:directive.tag import="gs.web.util.PageHelper"/>
    <jsp:directive.tag import="org.apache.commons.lang.StringUtils"/>
    <jsp:directive.tag import="org.apache.log4j.Logger"/>
    <jsp:directive.tag import="gs.web.util.UrlUtil"/>
    <jsp:directive.tag import="gs.web.util.context.SessionContextUtil"/>
    <jsp:directive.tag import="gs.web.util.CookieUtil"/>
    <jsp:directive.tag import="gs.web.util.context.SessionContext"/>
    <jsp:directive.tag import="java.util.*"/>
    <jsp:directive.tag import="gs.web.util.AdUtil"/>

    <jsp:scriptlet><![CDATA[
        PageHelper pageHelper = (PageHelper) request.getAttribute(PageHelper.REQUEST_ATTRIBUTE_NAME);
        Logger _log = Logger.getLogger("xGAMsetup.tagx");
        // GS-12415 map for getting width and height of ad
        Map<String,AdPosition> adNameAdPositionMap = new HashMap<String,AdPosition>();
        if (null != pageHelper) {
            List<String> adNames = new ArrayList<String>();
            Set adPositions = pageHelper.getAdPositions();
            String slotPrefix = (String) request.getAttribute(AdTagHandler.REQUEST_ATTRIBUTE_SLOT_PREFIX_NAME);

            if (StringUtils.isEmpty(slotPrefix)) {
                if (!"interstitial".equals(pageHelper.getPageName())
                        && !"error500".equals(pageHelper.getPageName())) {
                    _log.warn("Setting ad slot with empty prefix: " + request.getRequestURL() + "; " + pageHelper.getPageName());
                    slotPrefix = "";
                }
            }

            if (hideDefaultAds == null || !hideDefaultAds.booleanValue()) {
                if (pageHelper.isShowingFooterAd()) {
                    if (request.getRequestURI() != null && request.getRequestURI().equals("/index.page")) {
                        AdUtil.adPositionAdNameHelper(adNameAdPositionMap, adNames, AdPosition.Homepage_Footer_728x90, slotPrefix, true);
                    } else {
                        AdUtil.adPositionAdNameHelper(adNameAdPositionMap, adNames, AdPosition.Footer_728x90, slotPrefix, true);
                        AdUtil.adPositionAdNameHelper(adNameAdPositionMap, adNames, AdPosition.Footer_Branded_Tandem_728x90, slotPrefix, true);
                    }
                }

                if (pageHelper.isShowingBannerAd() && pageHelper.isShowingLeaderboard()) {
                    AdUtil.adPositionAdNameHelper(adNameAdPositionMap, adNames, AdPosition.Header_728x90, slotPrefix, true);
                    AdUtil.adPositionAdNameHelper(adNameAdPositionMap, adNames, AdPosition.Header_Branded_Tandem_728x90, slotPrefix, true);
                }

                if (!pageHelper.isAdFree() && !pageHelper.isFramed() && !pageHelper.isAdServedByCobrand()) {
                    AdUtil.adPositionAdNameHelper(adNameAdPositionMap, adNames, AdPosition.Global_NavPromo_970x30, slotPrefix, false);
                    AdUtil.adPositionAdNameHelper(adNameAdPositionMap, adNames, AdPosition.Custom_Welcome_Ad, slotPrefix, false);
                }
            }

            for (Iterator iter = adPositions.iterator(); iter.hasNext();) {
                AdPosition ad = (AdPosition) iter.next();
                if (ad.isGAMPosition()) {
                    if (StringUtils.isEmpty(slotPrefix)) {
                        slotPrefix = "";
                        _log.warn(">empty prefix for: " + ad.getName());
                    }
                    _log.warn(ad.getName());
                    AdUtil.adPositionAdNameHelper(adNameAdPositionMap, adNames, ad, slotPrefix, true);
                }
            }

            if (UrlUtil.isDevEnvironment(request.getServerName())) {
                pageHelper.addAdKeyword("env", "dev");
            } else {
                pageHelper.addAdKeyword("env", "prod");
            }

            if (!pageHelper.hasAdKeyword("template") || !pageHelper.hasAdKeywordWithValue("template","homepage")) {
                // "run of site" is the default value added if the value "homepage" has not already been added
                pageHelper.addAdKeywordMulti("template","ros");
            }

            SessionContext sessionContext = SessionContextUtil.getSessionContext(request);
            if (sessionContext != null) {
                if (sessionContext.getCobrand() != null) {
                    pageHelper.addAdKeyword("cobrand", "true");
                    pageHelper.addAdKeyword("cobrandName", sessionContext.getCobrand());
                }

                if (sessionContext.getMemberId() != null) {
                    pageHelper.addAdKeyword("member", "true");
                }

                // GS-12370 add GAM ad attribute so that GAM ad targeting can be set up to serve to usera, userb, userc, etc.
                pageHelper.addAdKeywordMulti("editorial", "user" + sessionContext.getABVersion());
            }

            if (CookieUtil.hasCookie(request, "pledged")) {
                pageHelper.addAdKeyword("pledge", "true");
            }

            request.setAttribute("GAMadNames", adNames);
            request.setAttribute("GAMadKeywords", pageHelper.getAdKeywords());
            request.setAttribute("GAMadSenseHint", pageHelper.getAdSenseHint());
            // GS-12415
            request.setAttribute("GPTadNameAdPositionMap", adNameAdPositionMap);
        }
        ]]></jsp:scriptlet>
    <c:if test="${!requestScope.pageHelper.adFree and !empty GAMadNames}">
    <c:choose>
    <c:when test="${requestScope.context.gptEnabled}">
        <c:choose>
            <c:when test="${requestScope.context.gptAsynchronousModeEnabled}">
                <![CDATA[
                <script type="text/javascript">
                    var googletag = googletag || {};
                    googletag.cmd = googletag.cmd || [];
                    (function() {
                        var gads = document.createElement('script');
                        gads.async = true;
                        gads.type = 'text/javascript';
                        var useSSL = 'https:' == document.location.protocol;
                        gads.src = (useSSL ? 'https:' : 'http:') +
                                '//www.googletagservices.com/tag/js/gpt.js';
                        var node = document.getElementsByTagName('script')[0];
                        node.parentNode.insertBefore(gads, node);
                    })();
                </script>
                ]]>
            </c:when>
            <c:otherwise>
                <![CDATA[
                <script type="text/javascript">
                  (function() {
                    var useSSL = 'https:' == document.location.protocol;
                    var src = (useSSL ? 'https:' : 'http:') +       '//www.googletagservices.com/tag/js/gpt.js';
                    document.write('<scr' + 'ipt src="' + src + '"></scr' + 'ipt>');
                  })();
                </script>
                ]]>
            </c:otherwise>
        </c:choose>

        <![CDATA[
        <script type="text/javascript">
            var GS = GS || {};
            GS.ad = GS.ad || {};
            GS.ad.targeting = GS.ad.targeting || {};
            GS.ad.targeting.pageLevel = GS.ad.targeting.pageLevel || {};
            GS.ad.slots = GS.ad.slots || {};
            GS.ad.slotTimers = GS.ad.slotTimers || {};
        ]]>

        <c:if test="${not empty requestScope.pageHelper.adPositionsWithIfConditionOnAdCalls}">
            <![CDATA[
                GS.ad.onSchoolProfileTab = function(hash, tabParamValue, tabName) {
                    var historySupported = (typeof(window.History) !== 'undefined' && window.History.enabled === true);
                    // hash tag is removed by js if history is supported, so ignore hash tag if history is supported
                    var containsHashTag = (hash !== '') && !historySupported;

                    if (containsHashTag && hash === '#!/' + tabName) {
                        return true;
                    } else if (!containsHashTag && tabName === tabParamValue) {
                        return true;
                    } else if (!containsHashTag && tabName === "overview" && tabParamValue === '') {
                        return true;
                    }
                    return false;
                };
                ]]>
        </c:if>
        <!-- WARNING: GS.ad.tabParamValue is needed whenever we're on any new school profile page -->
        <c:if test="${not empty requestScope.pageHelper.adPositionsWithIfConditionOnAdCalls or
                      requestScope.context.gptSlotLevelTargetingEnabled}">
            <![CDATA[
                GS.ad.tabParamValue = '${param.tab}';
            ]]>
        </c:if>

        <![CDATA[
                GS.ad.refreshAds = function(slotKeys) {
                    if(typeof(googletag) !== 'undefined' && googletag.pubads) {
            ]]>
        <c:if test="${requestScope.context.gptAsynchronousModeEnabled}">
            <![CDATA[
                        var adSlots = [];
                        for(key in slotKeys) {
                            if(GS.ad.slotTimers[slotKeys[key]] === undefined ||
                                    ((new Date().getTime()) - GS.ad.slotTimers[slotKeys[key]].timestamp >= 1000)) {
                                GS.ad.slotTimers[slotKeys[key]] = new Timer(slotKeys[key]);
                                adSlots.push(GS.ad.slots[slotKeys[key]]);
                            }
                        }
                        googletag.pubads().refresh(adSlots);
            ]]>
        </c:if>
        <![CDATA[
                    }
                };
            ]]>

        <![CDATA[
                GS.ad.setTargeting = function(slotKeys, key, value) {
            ]]>
        <c:if test="${requestScope.context.gptAsynchronousModeEnabled}">
            <![CDATA[
                    for (slotKey in slotKeys) {
                        var slot = GS.ad.slots[slotKeys[slotKey]];
                        if (slot !== undefined) {
                            slot.clearTargeting();
                            slot.setTargeting(key, value);
                        }
                    }
            ]]>
        </c:if>
        <![CDATA[
                };

                GS.ad.setTargetingAndRefresh = function(slotKeys, key, value) {
                    GS.ad.setTargeting(slotKeys, key, value);
                    GS.ad.refreshAds(slotKeys);
                };

                function Timer(adSlot) {
                    this.adSlot = adSlot;
                    this.timestamp = new Date().getTime();
                }
            ]]>

        <c:if test="${requestScope.context.gptAsynchronousModeEnabled}">
            <![CDATA[
            googletag.cmd.push(function() {
            ]]>
        </c:if>

        <![CDATA[
            if(typeof(googletag) !== 'undefined' && googletag.pubads) {
        ]]>
            <c:set var="compfilter" value="${gsweb:randomNumber(4)+1}"/>
            <c:forEach var="keywordEntry" items="${GAMadKeywords}">
                GS.ad.targeting.pageLevel["${keywordEntry.key}"] = [<c:forEach var="keywordValue" items="${keywordEntry.value}" varStatus="status">"${keywordValue}"<c:if test="${!status.last}">,</c:if></c:forEach>];
                googletag.pubads().setTargeting("${keywordEntry.key}", GS.ad.targeting.pageLevel["${keywordEntry.key}"]);
            </c:forEach>
        <![CDATA[
                googletag.pubads().setTargeting("compfilter", "${compfilter}");
        ]]>

        <c:forEach var="slotName" items="${GAMadNames}">
                <c:set var="adPosition" value="${GPTadNameAdPositionMap[slotName]}"/>
                <c:set var="adSizes" value="${gsweb:contains(requestScope.pageHelper.adPositionsWithOmittedCompanionSizes,adPosition) ? adPosition.sizes : adPosition.allSizes}"/>

                <c:set var="associatedTab" value="${gsweb:get(requestScope.pageHelper.adPositionsWithIfConditionOnAdCalls,adPosition)}"/>

                <c:if test="${associatedTab != null}">
                if (GS.ad.onSchoolProfileTab(window.location.hash, GS.ad.tabParamValue, '${associatedTab}')) {
                </c:if>

                <!-- GS-13764 The 300x125 slot should always display the ad ROS_TextAd_Top_300x125 -->
                <c:set var="unitName" value="${slotName}"/>
                <c:if test="${fn:endsWith(slotName, '_300x125')}">
                    <c:set var="unitName" value="ROS_TextAd_Top_300x125"/>
                </c:if>

                GS.ad.slots['${slotName}'] = googletag.defineSlot('/1002894/${unitName}', <c:choose>
                    <c:when test="${fn:length(adSizes) > 1}">[<c:forEach var="size" items="${adSizes}" varStatus="status">[${size.width},${size.height}]<c:if test="${!status.last}">, </c:if></c:forEach>]</c:when>
                    <c:otherwise>[${adPosition.size.width},${adPosition.size.height}]</c:otherwise>
                </c:choose>, <c:choose>
                    <c:when test="${gsweb:contains(requestScope.pageHelper.adPositionsWithDisabledGptGhostTextHiding,adPosition)}">'gpt${adPosition.name}'</c:when>
                    <c:otherwise>'ad${adPosition.name}'</c:otherwise>
                </c:choose>);
                GS.ad.slots['${slotName}'].addService(googletag.pubads());

                GS.ad.slotTimers['${slotName}'] = new Timer('${slotName}');

                <c:if test="${requestScope.context.gptSlotLevelTargetingEnabled}">
                    <c:forEach var="keywordEntry" items="${requestScope.context.gptSlotLevelTargetingKeyAssignments}">
                        GS.ad.slots['${slotName}'].setTargeting('${keywordEntry.key}',GS.ad.targeting.pageLevel['${keywordEntry.key}'].concat(${keywordEntry.value}[GS.ad.tabParamValue]));
                    </c:forEach>
                </c:if>

                <c:if test="${associatedTab != null}">
                } else {
                    $(function() {
                        document.getElementById('ad${adPosition.name}').style.display = 'none';
                    });
                }
                </c:if>
            </c:forEach>

            <![CDATA[
                googletag.pubads().collapseEmptyDivs();
                googletag.pubads().enableSingleRequest();
            ]]>
            <c:if test="${!requestScope.context.gptAsynchronousModeEnabled}">
                <![CDATA[
                    googletag.pubads().enableSyncRendering();
                ]]>
            </c:if>
            <![CDATA[
                googletag.enableServices();
                }
            ]]>

            <c:if test="${requestScope.context.gptAsynchronousModeEnabled}">
            <![CDATA[
                });
            ]]>
            </c:if>
        <![CDATA[
        </script>
        ]]>
    </c:when>
    <c:otherwise>
        <jsp:scriptlet>
            /*
            Explanation of compfilter attribute from Sera:

            We can use the compfilter for a couple of different things. One is to make
            sure competing ads don't appear on the same page - i.e. we make Concerta a
            "1" and Adderall a "2" so that Concerta only appears when "1" is displayed
            and Adderall only appears when a "2" is displayed and thus they never
            appear together.

            Another way we use this is for companion ads - i.e. we exclusively set the
            Concerta banner, sky and box all to display every time a "2" is shown so
            that the ads always show together.

            We can also use the exclusive feature to rig share of voice, as "1" ought
            to appear approximately 25% of the time.
            */
            /*
             Google Ad Manager Tagging Guide:
             https://www.google.com/admanager/help/en_US/tips/tagging.html
             */
        </jsp:scriptlet>
            <![CDATA[<script type="text/javascript" src="http://partner.googleadservices.com/gampad/google_service.js"></script>]]>
            <script type="text/javascript">                 
              GS_googleAddAdSenseService("ca-pub-9662012843341888");
              GS_googleEnableAllServices();
            </script>
            <![CDATA[<script type="text/javascript">
            <!--]]>
            <c:forEach var="keywordEntry" items="${GAMadKeywords}">
                <c:forEach var="keywordValue" items="${keywordEntry.value}">
                    GA_googleAddAttr('${keywordEntry.key}','${keywordValue}');
                </c:forEach>
            </c:forEach>
            GA_googleAddAttr('compfilter','${gsweb:randomNumber(4)+1}');
            <![CDATA[
            -->
            </script>
            ]]>
            <![CDATA[<script type="text/javascript">
            <!--]]>
            <c:forEach var="slotName" items="${GAMadNames}">
                GA_googleAddSlot("ca-pub-9662012843341888", '${slotName}');</c:forEach>
            <!-- Implemented for GS-7089, commented out for GS-7451: -->
            <!-- c:if test="${not empty GAMadSenseHint}">
                <c:forEach var="slotName" items="${GAMadNames}">
                    GA_googleAddAdSenseSlotAttr('${slotName}','google_hints','${GAMadSenseHint}');
                </c:forEach>
            </c:if -->            
            <![CDATA[
            -->
            </script>
            ]]>
            <script type="text/javascript">
                GA_googleUseSyncSRARendering();
                GA_googleFetchAds();
            </script>
    </c:otherwise>
    </c:choose>
    </c:if>
</jsp:root>