<?xml version="1.0" encoding="UTF-8"?>
<jsp:root version="2.0"
          xmlns:jsp="http://java.sun.com/JSP/Page"
          xmlns:c="http://java.sun.com/jsp/jstl/core"
          xmlns:fn="http://java.sun.com/jsp/jstl/functions"
          xmlns:gsweb="gstaglib">

    <jsp:directive.attribute name="hideDefaultAds" type="java.lang.Boolean" required="false"/>
    <jsp:directive.tag body-content="empty"
                       description="Generates necessary JavaScript to show the ads on a page. Generally you will not call this directly, but it will be called by the page decorator."/>
    <jsp:directive.tag import="gs.web.ads.AdPosition"/>
    <jsp:directive.tag import="gs.web.ads.AdTagHandler"/>
    <jsp:directive.tag import="gs.web.util.AdUtil"/>
    <jsp:directive.tag import="gs.web.util.CookieUtil"/>
    <jsp:directive.tag import="gs.web.util.PageHelper"/>
    <jsp:directive.tag import="gs.web.util.UrlUtil"/>
    <jsp:directive.tag import="gs.web.util.context.SessionContext"/>
    <jsp:directive.tag import="gs.web.util.context.SessionContextUtil"/>
    <jsp:directive.tag import="org.apache.commons.lang.StringUtils"/>
    <jsp:directive.tag import="org.apache.log4j.Logger"/>
    <jsp:directive.tag import="java.util.*"/>

    <jsp:scriptlet><![CDATA[
        PageHelper pageHelper = (PageHelper) request.getAttribute(PageHelper.REQUEST_ATTRIBUTE_NAME);
        Logger _log = Logger.getLogger("xGPTMobileSetup.tagx");
        // GS-12415 map for getting width and height of ad
        Map<String,AdPosition> adNameAdPositionMap = new HashMap<String,AdPosition>();
        if (null != pageHelper) {
            List<String> adNames = new ArrayList<String>();
            Set adPositions = pageHelper.getAdPositions();
            String slotPrefix = (String) request.getAttribute(AdTagHandler.REQUEST_ATTRIBUTE_SLOT_PREFIX_NAME);

            if (StringUtils.isEmpty(slotPrefix)) {
                if (!"interstitial".equals(pageHelper.getPageName())
                        && !"error500".equals(pageHelper.getPageName())) {
                    _log.warn("Setting ad slot with empty prefix: " + request.getRequestURL() + "; " + pageHelper.getPageName());
                    slotPrefix = "";
                }
            }

            for (Iterator iter = adPositions.iterator(); iter.hasNext();) {
                AdPosition ad = (AdPosition) iter.next();
                if (ad.isGAMPosition()) {
                    if (StringUtils.isEmpty(slotPrefix)) {
                        slotPrefix = "";
                        _log.warn(">empty prefix for: " + ad.getName());
                    }
                    AdUtil.adPositionAdNameHelper(adNameAdPositionMap, adNames, ad, slotPrefix, true);
                }
            }

            if (UrlUtil.isDevEnvironment(request.getServerName())) {
                pageHelper.addAdKeyword("env", "dev");
            }

            if (!pageHelper.hasAdKeyword("template")) {
                // "run of site" is the default value if no other code has already set it,
                // e.g. in a controller. note that setting this in a jspx or tagx file
                // which gets processed after xGAMSetup.tagx will still work because
                // adding a non-multi value replaces any existing one
                pageHelper.addAdKeyword("template","ros");
            }

            SessionContext sessionContext = SessionContextUtil.getSessionContext(request);
            if (sessionContext != null) {
                if (sessionContext.getCobrand() != null) {
                    pageHelper.addAdKeyword("cobrand", "true");
                    pageHelper.addAdKeyword("cobrandName", sessionContext.getCobrand());
                }

                if (sessionContext.getMemberId() != null) {
                    pageHelper.addAdKeyword("member", "true");
                }

                // GS-12370 add GAM ad attribute so that GAM ad targeting can be set up to serve to usera, userb, userc, etc.
                pageHelper.addAdKeywordMulti("editorial", "user" + sessionContext.getABVersion());
            }

            if (CookieUtil.hasCookie(request, "pledged")) {
                pageHelper.addAdKeyword("pledge", "true");
            }

            request.setAttribute("GAMadNames", adNames);
            request.setAttribute("GAMadKeywords", pageHelper.getAdKeywords());
            request.setAttribute("GAMadSenseHint", pageHelper.getAdSenseHint());
            // GS-12415
            request.setAttribute("GPTadNameAdPositionMap", adNameAdPositionMap);
        }
        ]]></jsp:scriptlet>

    <!-- All the different variations for loading GPT -->
    <c:set var="asyncStandardJS"><![CDATA[
        <script type="text/javascript">
            var googletag = googletag || {};
            googletag.cmd = googletag.cmd || [];
            (function() {
                var gads = document.createElement('script');
                gads.async = true;
                gads.type = 'text/javascript';
                var useSSL = 'https:' == document.location.protocol;
                gads.src = (useSSL ? 'https:' : 'http:') +
                        '//www.googletagservices.com/tag/js/gpt.js';
                var node = document.getElementsByTagName('script')[0];
                node.parentNode.insertBefore(gads, node);
            })();
        </script>
        ]]>
    </c:set>
    <c:set var="syncStandardJS"><![CDATA[
        <script type="text/javascript">
          (function() {
            var useSSL = 'https:' == document.location.protocol;
            var src = (useSSL ? 'https:' : 'http:') +       '//www.googletagservices.com/tag/js/gpt.js';
            document.write('<scr' + 'ipt src="' + src + '"></scr' + 'ipt>');
          })();
        </script>
        ]]>
    </c:set>

    <!-- determine if async mode is enabled -->
    <c:set var="asyncModeEnabled" value="${requestScope.context.advertisingOnMobileOnline and requestScope.context.gptAsynchronousModeOnMobileEnabled}"/>

    <c:choose>
        <!-- mobile advertising is online -->
        <c:when test="${requestScope.context.advertisingOnMobileOnline}">
            <c:choose>
                <c:when test="${asyncModeEnabled}">
                    ${asyncStandardJS}
                </c:when>
                <c:otherwise>
                    ${syncStandardJS}
                </c:otherwise>
            </c:choose>

            <![CDATA[
            <script type="text/javascript">
            ]]>
            <c:if test="${asyncModeEnabled}">
                <![CDATA[
                googletag.cmd.push(function() {
                ]]>
            </c:if>

            <c:forEach var="slotName" items="${GAMadNames}">
                <c:set var="adPosition" value="${GPTadNameAdPositionMap[slotName]}"/>
                googletag.defineSlot('/1002894/${slotName}', <c:choose>
                <c:when test="${fn:length(adPosition.allSizes) > 1}">[<c:forEach var="size" items="${adPosition.allSizes}" varStatus="status">[${size.width},${size.height}]<c:if test="${!status.last}">, </c:if></c:forEach>]</c:when>
                <c:otherwise>[${adPosition.size.width},${adPosition.size.height}]</c:otherwise>
            </c:choose>, 'gpt${slotName}')
                .addService(googletag.pubads());
            </c:forEach>

            <c:forEach var="keywordEntry" items="${GAMadKeywords}">
                googletag.pubads().setTargeting("${keywordEntry.key}", <c:choose>
                <c:when test="${fn:length(keywordEntry.value) == 1}">"${keywordEntry.value[0]}"</c:when>
                <c:otherwise>[<c:forEach var="keywordValue" items="${keywordEntry.value}" varStatus="status">"${keywordValue}"<c:if test="${!status.last}">,</c:if></c:forEach>]</c:otherwise>
            </c:choose>);
            </c:forEach>
            <![CDATA[
                googletag.pubads().setTargeting("compfilter", "${gsweb:randomNumber(4)+1}");
            ]]>

            <![CDATA[
                googletag.pubads().collapseEmptyDivs();
                googletag.pubads().enableSingleRequest();
            ]]>
            <c:if test="${!asyncModeEnabled}">
                googletag.pubads().enableSyncRendering();
            </c:if>
            <![CDATA[
                googletag.enableServices();
            ]]>
            <c:if test="${asyncModeEnabled}">
            <![CDATA[
                });
            ]]>
            </c:if>

            <![CDATA[
            </script>
            ]]>
    </c:when>
    <c:otherwise>
        <jsp:scriptlet>
            /*
              OTHERWISE Display nothing for ads, Mobile is GPT only at this point.
             */
        </jsp:scriptlet>
    </c:otherwise>
    </c:choose>
</jsp:root>