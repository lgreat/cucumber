<?xml version="1.0" encoding="UTF-8"?>
<jsp:root version="2.0"
          xmlns:jsp="http://java.sun.com/JSP/Page"
          xmlns:c="http://java.sun.com/jsp/jstl/core"
          xmlns:fn="http://java.sun.com/jsp/jstl/functions"
          xmlns:pageHelper="urn:jsptagdir:/WEB-INF/tags/pageHelper"
          xmlns:gsml="urn:jsptagdir:/WEB-INF/tags/gsml"
          xmlns:link="urn:www.greatschools.org/taglib/link"
          xmlns:ratings="urn:jsptagdir:/WEB-INF/tags/ratings"
          xmlns:map="urn:jsptagdir:/WEB-INF/tags/map"
        >
<jsp:directive.tag body-content="empty"
                   description="Draw a map of a school with nearby schools marked and extra info in a bubble." />
<jsp:directive.attribute name="id" required="true" description="XML id of the Html div element that holds the map."/>
<jsp:directive.attribute name="school" required="true" type="gs.data.school.School" description="The school this map is centered on"/>
<jsp:directive.attribute name="schools" required="true" description="Schools to map" type="java.util.Collection"/>
<jsp:directive.attribute name="tooltips" required="false" description="Use tooltips?" />
<jsp:directive.attribute name="minZoom" required="false" type="java.lang.Integer" description="Minimum google zoom to start with, defaults to 9"/>
<jsp:directive.attribute name="maxZoom" required="false" type="java.lang.Integer" description="Maximum google zoom to start with, defaults to 12"/>

<map:setup/>
<pageHelper:addOnLoadHandler handler="doMapSchools()"/>

<script type="text/javascript">
<![CDATA[
<!--
]]>

function extendBoundsToCenterOnPoint(point, bounds) {
  bounds.extend(reflectPoint(point, bounds.getNorthEast()));
  bounds.extend(reflectPoint(point, bounds.getSouthWest()));
}

// Given points x (outlier) and y (center), returns point z such that the rectangle defined by
// x and z has its center at y. Returns a GLatLng object
function reflectPoint(centerPoint, outlierPoint) {
  return new GLatLng(centerPoint.lat() + (centerPoint.lat() - outlierPoint.lat()),
                     centerPoint.lng() + (centerPoint.lng() - outlierPoint.lng()));
}

var minZoom = ${not empty minZoom?minZoom:6};
var maxZoom = ${not empty maxZoom?maxZoom:13};
var displayTooltips = ${not empty tooltips};
var schoolArray = new Array();
var centerSchool = new Object();
centerSchool.name = "${school.name}";
centerSchool.street = "${school.physicalAddress.street}";
centerSchool.city = "${school.physicalAddress.city}";
centerSchool.state = "${school.physicalAddress.state.abbreviation}";
centerSchool.zip = "${school.physicalAddress.zip}";
centerSchool.phone = '<c:if test="${not empty school.phone}">${school.phone}</c:if>';
centerSchool.address = centerSchool.street + ' ' + centerSchool.city + ', ' + centerSchool.state + ' ' + centerSchool.zip;
centerSchool.location = new GLatLng(${school.lat}, ${school.lon});

centerSchool.ratingHtml = '';
<c:if test="${gs_rating ne null and gs_rating gt 0 and gs_rating lt 11}">
    <c:set var="schoolRatingImg">
        <ratings:ratingsSprite isNewGsRating="${school.isNewGSRating}" gsRating="${gs_rating}" schoolType="${school.type.schoolTypeName}" isPreschoolOnly="${school.levelCode eq 'p'}" spriteSize="small"/>
    </c:set>
var schoolRatingImg = '${fn:trim(schoolRatingImg)}';

    centerSchool.ratingHtml = '<div class="schoolRating" style="float: left"><link:schoolProfileRating school="${school}" title="GreatSchools Rating: ${gs_rating} out of 10. Greatschools Ratings are based on test results. 10 is best.">' +
                       schoolRatingImg +
                       '</link:schoolProfileRating></div>';
</c:if>
centerSchool.parentRatingHtml = '<div class="parentRating" style="float: left">';
<c:set var="parent_rating" value="0"/>
<c:if test="${parent_ratings.displayOverallRating eq true}">
    <c:set var="parent_rating" value="${parent_ratings.overall}"/>
</c:if>

<c:choose>
    <c:when test="${parent_rating eq 0}">
        <c:set var="parent_rating_title" value="Be the first to rate!"/>
        centerSchool.parentRatingHtml += '<link:schoolProfileParentReview
                school="${school}"><img src="/res/img/school/ratings/ratings_parent_head_no.gif" alt="${parent_rating_title}" onmouseover="this.src=\\'/res/img/school/ratings/ratings_parent_head_no_roll.gif\\'" onmouseout="this.src=\\'/res/img/school/ratings/ratings_parent_head_no.gif\\'"/></link:schoolProfileParentReview>';
    </c:when>
    <c:otherwise>
        <c:set var="parent_rating_title" value="Parent Rating: ${parent_rating} out of 5 stars"/>
        centerSchool.parentRatingHtml += '<link:schoolProfileParentReview school="${school}"><span class="sprite stars_sm_${parent_rating}"><!-- do not collapse --></span></link:schoolProfileParentReview>';
    </c:otherwise>
</c:choose>
centerSchool.parentRatingHtml += '</div>';

function initSchoolInfo() {
    var mySchool;
    var schoolRatingImg;
<c:forEach var="nearbySchool" items="${schools}">
  <c:set var="curSchool" value="${nearbySchool.neighbor}"/>   
  <c:if test="${not empty curSchool.lon}">
    mySchool = new Object();

    mySchool.name = "${curSchool.name}";
    mySchool.street = "${curSchool.physicalAddress.street}";
    mySchool.city = "${curSchool.physicalAddress.city}";
    mySchool.state = "${curSchool.physicalAddress.state.abbreviation}";
    mySchool.zip = "${curSchool.physicalAddress.zip}";
    mySchool.phone = '<c:if test="${not empty curSchool.phone}">${curSchool.phone}</c:if>';
    mySchool.address = centerSchool.street + ' ' + centerSchool.city + ', ' + centerSchool.state + ' ' + centerSchool.zip;

    mySchool.ratingHtml = '';
    <c:if test="${nearbySchool.rating ne null and nearbySchool.rating gt 0 and nearbySchool.rating lt 11}">
        <c:set var="schoolRatingImg">
           <ratings:ratingsSprite isNewGsRating="${curSchool.isNewGSRating}" gsRating="${nearbySchool.rating}" schoolType="${curSchool.type.schoolTypeName}" isPreschoolOnly="${curSchool.levelCode eq 'p'}" spriteSize="small"/>
        </c:set>
        schoolRatingImg = '${fn:trim(schoolRatingImg)}';
        mySchool.ratingHtml = '<div class="schoolRating" style="float: left"><link:schoolProfileRating school="${curSchool}" title="GreatSchools Rating: ${nearbySchool.rating} out of 10. Greatschools Ratings are based on test results. 10 is best.">'+
                           schoolRatingImg +
                           '</link:schoolProfileRating></div>';
    </c:if>
    mySchool.parentRatingHtml = '<div class="parentRating" style="float: left">';
    <c:set var="parent_rating" value="0"/>
    <c:if test="${(nearbySchool.parentRatings ne null) and (nearbySchool.parentRatings.displayOverallRating eq true)}">
        <c:set var="parent_rating" value="${nearbySchool.parentRatings.overall}"/>
    </c:if>
    <c:choose>
        <c:when test="${parent_rating eq 0}">
            <c:set var="parent_rating_title" value="Be the first to rate!"/>
            mySchool.parentRatingHtml += '<link:schoolProfileParentReview school="${curSchool}"
                                title="${parent_rating_title}"><img src="/res/img/school/ratings/ratings_parent_head_no.gif" alt="Be the first to rate!" onmouseover="this.src=\\'/res/img/school/ratings/ratings_parent_head_no_roll.gif\\'" onmouseout="this.src=\\'/res/img/school/ratings/ratings_parent_head_no.gif\\'"/></link:schoolProfileParentReview>';
        </c:when>
        <c:otherwise>
            <c:set var="parent_rating_title" value="Parent Rating: ${parent_rating} out of 5 stars"/>
            mySchool.parentRatingHtml += '<link:schoolProfileParentReview school="${curSchool}" title="${parent_rating_title}"><span class="sprite stars_sm_${parent_rating}"><!-- do not collapse --></span></link:schoolProfileParentReview>';
        </c:otherwise>
    </c:choose>
    mySchool.parentRatingHtml += '</div>';

    mySchool.location = new GLatLng(${curSchool.lat},${curSchool.lon});
    schoolArray.push(mySchool);
  </c:if>
</c:forEach>
}

<![CDATA[
function getSchoolInfoWindowHtml(school) {
    var height = 90; // default height
    var heightMultiplier = Math.floor(school.name.length / 30);
    // add 13 pixels (font line-height) for every multiple of 30 that the school name's length exceeds
    // this is a guesstimate of how many chars it takes to wrap to the next line
    height += heightMultiplier * 13;
    
    var rval = '<div class="schoolInfoWindow" style="font: 12px/15px Trebuchet MS, sans-serif; height: ' + height + 'px;">';
    rval += '<div class="schoolName" style="width: 210px;">' + school.name + '</div>';
    rval += '<div>';
    rval += '<div class="line">';
    rval += '<div class="schoolRatings unit size49of100">';
    rval += school.ratingHtml;
    rval += school.parentRatingHtml;
    rval += '</div>';
    rval += '<div class="unit size1of100">&nbsp;'; //
    rval += '</div>';
    rval += '<div class="schoolAddress  unit size49of100">';
    rval += '<address style="width: 210px; clear: left; margin-top: 10px; _margin-top: 5px;">';
    rval += school.street + '<br />';
    rval += school.city + ', ' + school.state + ' ' + school.zip + '<br/>';
    rval += '</address>';
    rval += '<a href="http://maps.google.com/maps?saddr=&amp;daddr=' +
            encodeURIComponent(school.address) +
            '" target="_blank" onclick="s.tl(this, \'o\', \'School Map - Get Directions\');">Get directions &gt;</a>';
    if (school.phone == '') {
        rval += '<br/><br/>';
    } else {
        rval += '<p class="schoolPhone">' + school.phone + '</p>';
    }
    rval += '</div>'; //
    rval += '<div class="unit size1of100 lastUnit">&nbsp;'; //
    rval += '</div>'; //
    rval += '</div>'; // line
    rval += '</div>'; // schoolInfoWindow
    return rval;
}
]]>

function initMap() {
    var i = 0;
    var tooltip = null;
    var map = new GMap2(document.getElementById("${id}"));
    var marker;

    map.addControl(new GLargeMapControl());
    map.addControl(new GScaleControl());
    map.setCenter(centerSchool.location, 17);
    var bounds = new GLatLngBounds();
    bounds.extend(centerSchool.location);
    <![CDATA[
    for (var counter=0; counter < schoolArray.length; counter++) {
      var curSchool = schoolArray[counter];
      if (displayTooltips) {
        tooltip = curSchool.name;
      } else {
        tooltip = null;
      }
      marker = new GMarker(curSchool.location, {title: tooltip});
      addBubbleListener(marker, curSchool);
      map.addOverlay(marker);
      bounds.extend(curSchool.location);
    }
    ]]>

    var arrowIcon = new GIcon();
    arrowIcon.image = "/res/img/map/green_arrow.png";
    arrowIcon.shadow = "/res/img/map/green_arrow_shadow.png";
    arrowIcon.transparent = "/res/img/map/green_arrow_transparent.png";
    arrowIcon.iconSize = new GSize(39,34);
    arrowIcon.iconAnchor = new GPoint(11,34);
    arrowIcon.infoWindowAnchor = new GPoint(13,2);
    arrowIcon.infoShadowAnchor = new GPoint(13,2);
    arrowIcon.shadowSize = new GSize(39,34);

    if (displayTooltips) {
      tooltip = centerSchool.name;
    } else {
      tooltip = null;
    }
    marker = new GMarker(centerSchool.location, {icon:arrowIcon, title: tooltip});
    addBubbleListener(marker, centerSchool);
    map.addOverlay(marker);
    extendBoundsToCenterOnPoint(centerSchool.location, bounds);

    var zoom = map.getBoundsZoomLevel(bounds);
    if (zoom > maxZoom) zoom = maxZoom;
    if (minZoom > zoom) zoom = minZoom;
    map.setZoom(zoom);
}

function addBubbleListener(marker, school) {
  GEvent.addListener(marker, "click", function() {
      if (s.tl &amp;&amp; s.pageName != undefined) {
          s.tl(true, 'o', 'Map_pin_click_' + s.pageName);
      }
      marker.openInfoWindowHtml(getSchoolInfoWindowHtml(school));
  });
}

function doMapSchools() {
  if (GBrowserIsCompatible()) {
      initSchoolInfo();
      initMap();
  }
}
-->
</script>

</jsp:root>