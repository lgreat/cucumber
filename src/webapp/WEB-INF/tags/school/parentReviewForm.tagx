<?xml version="1.0" encoding="UTF-8"?>
<jsp:root version="2.0"
          xmlns:jsp="http://java.sun.com/JSP/Page"
          xmlns:c="http://java.sun.com/jsp/jstl/core"
          xmlns:gsml="urn:jsptagdir:/WEB-INF/tags/gsml"
          xmlns:link="urn:www.greatschools.org/taglib/link"
          xmlns:pageHelper="urn:jsptagdir:/WEB-INF/tags/pageHelper"
          xmlns:yui="urn:jsptagdir:/WEB-INF/tags/yui"
          xmlns:fn="http://java.sun.com/jsp/jstl/functions"
          xmlns:gsweb="gstaglib">
<jsp:directive.tag import="gs.web.util.context.SessionContext"/>
<jsp:directive.tag import="gs.web.util.context.SessionContextUtil"/>
<jsp:directive.tag import="org.apache.commons.lang.StringUtils"/>

<jsp:directive.attribute name="school" required="true" description="School object" type="gs.data.school.School"/>
    <jsp:directive.attribute name="pageName" required="true" description="Page this module appears on"/>
    <pageHelper:externalCss file="/res/css/school/parentReviews/parentReviewForm.css"/>
    <pageHelper:externalJavascript file="/res/js/parentReviewForm.js"/>
    <yui:connectionManager/>
    <c:set var="state" value="${school.databaseState.abbreviationLowerCase}"/>
    <c:set var="schoolId" value="${school.id}"/>
    <gsml:url var="formActionUrl" value="/school/ajaxAddComments.page"/>
    <gsml:url var="ratingPage" value="/school/updateRatings.page?id=${schoolId}&amp;state=${state}"/>
    <jsp:scriptlet>
        SessionContext sessionContext = SessionContextUtil.getSessionContext(request);
        String email = sessionContext.getEmail();
        request.setAttribute("email", email);

        boolean showName = false;
        if (StringUtils.isNotBlank(request.getParameter("showName"))) {
            showName = true;
        }
        request.setAttribute("showName", showName);

        String presetRating = "0";
        if (StringUtils.isNotBlank(request.getParameter("presetRating"))) {
            presetRating = request.getParameter("presetRating");
        }
        request.setAttribute("presetRating", presetRating);

        String showMessage = "no";
        if (StringUtils.isNotBlank(request.getParameter("showMessage"))) {
            showMessage = request.getParameter("showMessage");
        }
        request.setAttribute("showMessage",showMessage);
    </jsp:scriptlet>
    
    <pageHelper:addOnLoadHandler handler="setStars(${presetRating})"/>
    <script type="text/javascript">
        <![CDATA[<!--
        function onAjaxSuccess(o) {
            AjaxObject.handleSuccess(o);
            ]]>
            <!-- Force recalculation of heights so the SEO text will
                 move down if error nodes are added -->
        <c:choose>
            <c:when test="${pageName eq 'parentReviews'}">
                         document.getElementById('col_left').style.height = null;
                         document.getElementById('col_right').style.height = null;
                         BoxHeights.equalize('col_left','col_right');
            </c:when>
            <c:when test="${pageName eq 'overview'}">
                         document.getElementById('col_center').style.height = null;
                         document.getElementById('col_right').style.height = null;
                         BoxHeights.equalize('col_center','col_right');
            </c:when>
        </c:choose>
            <![CDATA[
        }
        var callback = {
            success: onAjaxSuccess,
            failure:AjaxObject.handleFailure,
            scope: AjaxObject,
            argument: ['${ratingPage}','${pageName}']
        };
        -->]]>
    </script>
    <c:set var="divClass" value=""/>
    <c:choose>
        <c:when test="${pageName eq 'parentReviews'}">
            <h2 id="rateReviewH2" class="noprint"><c:out escapeXml="true" value="Rate &amp; Review ${school.name}"/></h2>
        </c:when>
        <c:when test="${pageName eq 'overview'}">
            <c:set var="divClass" value="overview"/>
        </c:when>
    </c:choose>
    <c:set var="schoolName" value="Rate this school"/>
    <c:if test="${showName}">
        <c:set var="schoolName" value="Rate ${school.name}"/>
    </c:if>

    <div id="rateReview" class="noprint ${divClass}">
    <c:if test="${showMessage eq 'yes'}">
        To save your rating please submit your email address.
    </c:if>
        <div id="ratingTitle">${schoolName}

        </div>
        <ul class="star-rating large-star">
                    <li id="currentStarDisplay" class="current-rating" style="width:0;">Currently unrated.</li>
                    <li><a href="#"
                           title="1 star out of 5"
                           class="one-star"
                           onclick="this.hideFocus=true;setStars(1);return false;"
                           onmouseover="showStars(1);"
                           onmouseout="resetStars();"
                            >1</a></li>
                    <li><a href="#" title="2 stars out of 5" class="two-stars"
                           onclick="this.hideFocus=true;setStars(2);return false;"
                           onmouseover="showStars(2);"
                           onmouseout="resetStars();"
                            >2</a></li>
                    <li><a href="#" title="3 stars out of 5" class="three-stars"
                           onclick="this.hideFocus=true;setStars(3);return false;"
                           onmouseover="showStars(3);"
                           onmouseout="resetStars();"
                            >3</a></li>
                    <li><a href="#" title="4 stars out of 5" class="four-stars"
                           onclick="this.hideFocus=true;setStars(4);return false;"
                           onmouseover="showStars(4);"
                           onmouseout="resetStars();"
                            >4</a></li>
                    <li><a href="#" title="5 stars out of 5" class="five-stars"
                           onclick="this.hideFocus=true;setStars(5);return false;"
                           onmouseover="showStars(5);"
                           onmouseout="resetStars();"
                            >5</a></li>
                </ul>
        <span id="parentReviewGuidelinesSpan"><link:parentReviewGuidelines>School Review Guidelines</link:parentReviewGuidelines></span>

        <c:if test="${fn:length(schoolName) > 31}">
            <script type="text/javascript">
                var title = document.getElementById('ratingTitle');
                title.style.height = '35px';
                title.style.lineHeight = '20px';
            </script>
        </c:if>
        
        <gsweb:form id="frmPRModule" action="${formActionUrl}" method="post" onsubmit="AjaxObject.startRequest(this.action,callback);return false;">
                <input type="hidden" id="hdnSchoolName" name="hdnSchoolName" value="${schoolName}"/>
                <!--Begin star ratings.
                    Not using the starRating tag since that tag relies on onload to set click and mouse listeners.
                    But because this page may load slowly, that's not an option.
                -->
                <pageHelper:externalCss file="/res/css/starRating/star_rating.css"/>
                <input type="hidden" id="overallStarRating" value="${presetRating}" name="overallAsString"/>

               <!-- end star ratings -->


                <input type="hidden" name="id" value="${schoolId}"/>
                <input type="hidden" name="state" value="${state}"/>
                <input type="hidden" name="source" value="${pageName}" />
                <input id="confirm" type="hidden" name="confirmEmail" value="" />
                <div  style="position:relative;" id="userInput">
                <textarea id="reviewText"
                          name="comments"
                          onkeyup="countWords(this)"
                          onkeydown="countWords(this)"
                          onfocus="if(this.value=='Enter your review here'){this.value='';}"
                          rows="" cols="">Enter your review here</textarea>

                <ul id="nonCommentInput">
                    <li>
                        <input id="permission" name="givePermission" type="checkbox" checked="checked"/>
                            I'm a  <select name="posterAsString">
                                        <option value="parent">parent</option>
                                        <option value="student">student</option>
                                        <option value="teacher">teacher</option>
                                        <option value="other">other</option>
                                    </select>  and I accept <span id="tos">the <gsml:a href="/terms/?state=${state}#permission" title="Terms of Use" target="_blank">Terms of Use</gsml:a></span>
                    </li>
                    <c:if test="${school.type.schoolTypeName ne 'private' and school.levelCode != 'p'}">
                        <li><input id="wantMssNL" type="checkbox" name="wantMssNL" value="yes" checked="checked"/> Send me updates about this school</li>
                    </c:if>

                    <li id="emailAndSubmit">
                        <c:set var="email" value="${(not empty email) ? email : 'Enter your email address'}" />
                        <input type="text" name="email" id="reviewEmail"
                            onfocus="if(this.value=='Enter your email address'){this.value='';}"
                            value="${email}" class="emailAddress"/>
                        <c:choose>
                            <c:when test="${pageName eq 'parentReviews'}">
                                <input id="submitReview" alt="Submit ${school.name} Parent Review and Rating" src="/res/img/school/parentReviews/submit.gif" type="image" />
                            </c:when>
                            <c:when test="${pageName eq 'overview'}">
                                <input id="submitReview"
                                    class="button" alt="Submit ${school.name} Parent Review and Rating" src="/res/img/school/review/submitReview.gif" type="image"
                                        onclick="clickCapture.capture('prop9', 'Review_Module');"/>
                            </c:when>
                            <c:otherwise>
                                <input id="submitReview"
                                    class="button" alt="Submit ${school.name} Parent Review and Rating" src="/res/img/school/review/submitReview.gif" type="image" />
                            </c:otherwise>
                        </c:choose>
                    </li>
                    <li id="privacyPolicy">GreatSchools <gsml:a href="/cgi-bin/static/privacy.inc/${state}" title="Privacy Policy" target="_blank">Privacy Policy</gsml:a></li>
                </ul>
                </div>
            </gsweb:form>

            <c:if test="${(pageName eq 'parentReviews') and school.levelCode != 'p'}">
                <div id="espLink">
                    <link:schoolProfileEspLogin styleClass="esp" school="${school}">Principals, submit your review here &gt;</link:schoolProfileEspLogin>
                </div>
            </c:if>
    </div>
</jsp:root>