<?xml version="1.0" encoding="UTF-8"?>
<jsp:root version="2.0"
          xmlns:jsp="http://java.sun.com/JSP/Page"
          xmlns:c="http://java.sun.com/jsp/jstl/core"
          xmlns:promo="urn:jsptagdir:/WEB-INF/tags/promo"
          xmlns:ad="urn:jsptagdir:/WEB-INF/tags/ad"
          xmlns:link="urn:www.greatschools.org/taglib/link"
          xmlns:pageHelper="urn:jsptagdir:/WEB-INF/tags/pageHelper"
          xmlns:school="urn:jsptagdir:/WEB-INF/tags/school"
          xmlns:gsml="urn:jsptagdir:/WEB-INF/tags/gsml"
          xmlns:fmt="http://java.sun.com/jsp/jstl/fmt"
          xmlns:map="urn:jsptagdir:/WEB-INF/tags/map"
          xmlns:fn="http://java.sun.com/jsp/jstl/functions"
            >
<!-- todo: simplify input requirements a bit -->
<jsp:directive.attribute name="pageSize" type="java.lang.Integer" required="true" description="Number of items to display per page"  />
<jsp:directive.attribute name="maxPages" type="java.lang.Integer" required="true" />
<jsp:directive.attribute name="school" type="gs.data.school.School" required="true" description="The main school to display at the top of the list"/>
<jsp:directive.attribute name="gsRating" type="java.lang.String" required="true" />
<jsp:directive.attribute name="mapSchools" type="java.util.List" required="true" description="list of MapSchool objects"/>
<jsp:directive.attribute name="ratings" type="gs.data.school.review.Ratings" required="true" description="An instance of Ratings" />

    <!-- begin nearby schools list -->
    <c:set var="TOTAL_SCHOOL_LIMIT" value="${pageSize * maxPages}"/>

    <c:set var="start" value="${param.start}"/>
    <c:if test="${empty start}">
        <c:set var="start" value="0"/>
    </c:if>
    <c:set var="thisPage" value="${(start + pageSize) / pageSize}"/>

    <c:set var="numberOfSchools" value="${fn:length(mapSchools)}"/>
    <c:set var="stragglers" value="${numberOfSchools % pageSize}"/>
    <c:choose>
        <c:when test="${stragglers ne 0}">
            <c:set var="blankRows" value="${pageSize - stragglers}"/>
        </c:when>
        <c:otherwise>
            <c:set var="blankRows" value="0"/>
        </c:otherwise>
    </c:choose>
    <c:choose>
        <c:when test="${numberOfSchools lt TOTAL_SCHOOL_LIMIT}">
            <c:set var="totalSchoolRows" value="${numberOfSchools}"/>
        </c:when>
        <c:otherwise>
            <c:set var="totalSchoolRows" value="${TOTAL_SCHOOL_LIMIT}"/>
        </c:otherwise>
    </c:choose>
    <c:choose>
        <c:when test="${numberOfSchools lt TOTAL_SCHOOL_LIMIT}">
            <c:set var="rowsToDisplay" value="${totalSchoolRows + blankRows}"/>
        </c:when>
        <c:otherwise>
            <c:set var="rowsToDisplay" value="${TOTAL_SCHOOL_LIMIT}"/>
        </c:otherwise>
    </c:choose>
    <c:set var="pages"><fmt:formatNumber value="${rowsToDisplay / pageSize}" maxFractionDigits="0"/></c:set>
    <c:choose>
        <c:when test="${pages lt maxPages}">
            <c:set var="totalPages" value="${pages}"/>
        </c:when>
        <c:otherwise>
            <c:set var="totalPages" value="${maxPages}"/>
        </c:otherwise>
    </c:choose>

    <c:set var="pageSize" value="4"/>

    <c:if test="${not empty mapSchools}">
        <c:choose>
        <c:when test="${school.levelCode ne 'p'}">
            <table id="nearby-schools-table-header">
                <colgroup>
                    <col align="center" width="62"/>
                    <col align="left" width="179"/>
                    <col align="right" width="90"/>
                    <col align="center" width="69"/>
                    <col align="center" width="7"/>
                </colgroup>
                <thead>
                <tr class="smallText2bold">
                    <th align="center">COMPARE</th>
                    <th class="text-align-lft">SCHOOL</th>
                    <th align="center">GREATSCHOOLS RATING</th>
                    <th align="center">PARENT RATING</th>
                    <th><!-- do not collapse --></th>
                </tr>
                </thead>
            </table>
            <table id="nearby-schools-table-body">
                <colgroup>
                    <col align="center" width="62"/>
                    <col align="left" width="212"/>
                    <col align="left" width="57"/>
                    <col align="center" width="76"/>
                </colgroup>
                <tbody>
                <tr>
                    <td class="bg-color-f9eccd brdbtm_dotted" align="center">
                        <input id="${school.databaseState}${school.id}" class="compare-school-checkbox"
                               type="checkbox"/><br/>
                        <label for="${school.databaseState}${school.id}" class="smallText2">COMPARE</label>
                    </td>
                    <td class="bg-color-f9eccd brdbtm_dotted">
                        <p class="text2bold nearby-schools-link" id="nearby-schools-link-${school.databaseState}${school.id}">
                            <link:schoolProfileOverview school="${school}">
                            ${school.name}
                            </link:schoolProfileOverview>
                        </p>

                        <p class="text3"><!-- not empty --></p>
                    </td>
                    <td class="bg-color-f9eccd brdbtm_dotted" align="left">
                        <c:choose>
                            <c:when test="${school.type.schoolTypeName == 'private'}">
                                <span class="sprite badge_sm_pr_y"><!-- do not collapse --></span>
                            </c:when>
                            <c:when test="${not empty gs_rating and gs_rating gt 0}">
                                <span class="sprite badge_sm_${gs_rating}_y"><!-- do not collapse --></span>
                            </c:when>
                            <c:otherwise>
                                <span class="sprite badge_sm_na_y"><!-- do not collapse --></span>
                            </c:otherwise>
                        </c:choose>
                    </td>
                    <td class="bg-color-f9eccd brdbtm_dotted" align="center">
                        <link:schoolProfileParentReview school="${school}">
                            <c:choose>
                                <c:when test="${not empty ratings.overall}">
                                    <span class="sprite stars_sm_${ratings.overall}_y"><!-- do not collapse --></span>
                                </c:when>
                                <c:otherwise>
                                    <span class="sprite stars_sm_rate_it_y"><!-- do not collapse --></span>
                                </c:otherwise>
                            </c:choose>
                        </link:schoolProfileParentReview>
                    </td>
                </tr>
                <c:set var="nearbySchoolClass" value="nearby-school"/>
                <c:set var="count" value="0"/>
                <c:forEach items="${mapSchools}" var="s" begin="0" end="${totalSchoolRows - 1}">
                    <c:set var="count" value="${count+1}"/>
                    <c:if test="${count gt pageSize}">
                        <c:set var="nearbySchoolClass" value="nearby-school hidden"/>
                    </c:if>
                    <tr class="${nearbySchoolClass}" id="nearby-schools-${s.neighbor.databaseState}${s.neighbor.id}">
                        <td class="brdbtm_dotted" align="center">
                            <input id="${s.neighbor.databaseState}${s.neighbor.id}" class="compare-school-checkbox"
                                   type="checkbox"/><br/>
                            <label for="${s.neighbor.databaseState}${s.neighbor.id}"
                                   class="smallText2">COMPARE</label>
                        </td>
                        <td class="brdbtm_dotted">
                            <p class="text2bold nearby-schools-link"
                               id="nearby-schools-link-${s.neighbor.databaseState}${s.neighbor.id}">
                                <link:schoolProfileOverview school="${s.neighbor}">
                                    ${s.neighbor.name}
                                </link:schoolProfileOverview></p>

                            <p class="text3"><fmt:formatNumber type="number" maxFractionDigits="1"
                                                               value="${s.distance}"/> miles</p>
                        </td>
                        <td class="brdbtm_dotted" align="left">
                            <c:choose>
                                <c:when test="${s.neighbor.type.schoolTypeName eq 'private'}">
                                    <span class="sprite badge_sm_pr"><!-- do not collapse --></span>
                                </c:when>
                                <c:when test="${not empty s.rating and s.rating gt 0}">
                                    <span class="sprite badge_sm_${s.rating}"><!-- do not collapse --></span>
                                </c:when>
                                <c:otherwise>
                                    <span class="sprite badge_sm_na"><!-- do not collapse --></span>
                                </c:otherwise>
                            </c:choose>
                        </td>
                        <td class="brdbtm_dotted" align="center">
                            <link:schoolProfileParentReview school="${school}">
                                <c:choose>
                                    <c:when test="${not empty s.parentRatings.overall}">
                                        <span class="sprite stars_sm_${s.parentRatings.overall}"><!-- do not collapse --></span>
                                    </c:when>
                                    <c:otherwise>
                                        <span class="sprite stars_sm_rate_it"><!-- do not collapse --></span>
                                    </c:otherwise>
                                </c:choose>
                            </link:schoolProfileParentReview>
                        </td>
                    </tr>
                </c:forEach>
                <c:choose>
                    <c:when test="${totalPages gt 1}">
                        <c:set var="nearbySchoolClass" value="nearby-school hidden"/>
                    </c:when>
                    <c:otherwise>
                        <c:set var="nearbySchoolClass" value="nearby-school"/>
                    </c:otherwise>
                </c:choose>
                <c:if test="${blankRows gt 0}">
                    <c:forEach begin="0" end="${blankRows - 1}">
                        <tr class="${nearbySchoolClass}">
                            <td class="brdbtm_dotted-fff"><!-- do not collapse --></td>
                            <td class="brdbtm_dotted-fff"><!-- do not collapse --></td>
                            <td class="brdbtm_dotted-fff"><!-- do not collapse --></td>
                            <td class="brdbtm_dotted-fff"><!-- do not collapse --></td>
                        </tr>
                    </c:forEach>
                </c:if>
                </tbody>
            </table>

        </c:when>
        <c:otherwise>
            <table id="nearby-schools-table-header">
                <colgroup>
                    <col align="center" width="7"/>
                    <col align="left" width="324"/>
                    <col align="center" width="69"/>
                    <col align="center" width="7"/>
                </colgroup>
                <thead>
                <tr class="smallText2bold">
                    <th><!-- do not collapse --></th>
                    <th class="text-align-lft">SCHOOL</th>
                    <th align="center">PARENT RATING</th>
                    <th><!-- do not collapse --></th>
                </tr>
                </thead>
            </table>
            <table id="nearby-schools-table-body">
                <colgroup>
                    <col align="center" width="7"/>
                    <col align="left" width="324"/>
                    <col align="center" width="76"/>
                </colgroup>
                <tbody>
                <tr>
                    <td class="bg-color-f9eccd brdbtm_dotted"><!-- do not collapse --></td>
                    <td class="bg-color-f9eccd brdbtm_dotted">
                        <p class="text2bold nearby-schools-link" id="nearby-schools-link-${school.databaseState}${school.id}">
                            <link:schoolProfileOverview school="${school}">
                            ${school.name}
                            </link:schoolProfileOverview>
                        </p>

                        <p class="text3"><!-- not empty --></p>
                    </td>
                    <td class="bg-color-f9eccd brdbtm_dotted" align="center">
                        <link:schoolProfileParentReview school="${school}">
                            <c:choose>
                                <c:when test="${not empty ratings.overall}">
                                    <span class="sprite stars_sm_${ratings.overall}_y"><!-- do not collapse --></span>
                                </c:when>
                                <c:otherwise>
                                    <span class="sprite stars_sm_rate_it_y"><!-- do not collapse --></span>
                                </c:otherwise>
                            </c:choose>
                        </link:schoolProfileParentReview>
                    </td>
                </tr>
                <c:set var="nearbySchoolClass" value="nearby-school"/>
                <c:set var="count" value="0"/>
                <c:forEach items="${mapSchools}" var="s" begin="0" end="${totalSchoolRows - 1}">
                    <c:set var="count" value="${count+1}"/>
                    <c:if test="${count gt pageSize}">
                        <c:set var="nearbySchoolClass" value="nearby-school hidden"/>
                    </c:if>
                    <tr class="${nearbySchoolClass}" id="nearby-schools-${s.neighbor.databaseState}${s.neighbor.id}">
                        <td class="brdbtm_dotted"><!-- do not collapse --></td>
                        <td class="brdbtm_dotted">
                            <p class="text2bold nearby-schools-link"
                               id="nearby-schools-link-${s.neighbor.databaseState}${s.neighbor.id}">
                                <link:schoolProfileOverview school="${s.neighbor}">
                                    ${s.neighbor.name}
                                </link:schoolProfileOverview></p>

                            <p class="text3"><fmt:formatNumber type="number" maxFractionDigits="1"
                                                               value="${s.distance}"/> miles</p>
                        </td>
                        <td class="brdbtm_dotted" align="center">
                            <link:schoolProfileParentReview school="${school}">
                                <c:choose>
                                    <c:when test="${not empty s.parentRatings.overall}">
                                        <span class="sprite stars_sm_${s.parentRatings.overall}"><!-- do not collapse --></span>
                                    </c:when>
                                    <c:otherwise>
                                        <span class="sprite stars_sm_rate_it"><!-- do not collapse --></span>
                                    </c:otherwise>
                                </c:choose>
                            </link:schoolProfileParentReview>
                        </td>
                    </tr>
                </c:forEach>
                <c:choose>
                    <c:when test="${totalPages gt 1}">
                        <c:set var="nearbySchoolClass" value="nearby-school hidden"/>
                    </c:when>
                    <c:otherwise>
                        <c:set var="nearbySchoolClass" value="nearby-school"/>
                    </c:otherwise>
                </c:choose>
                <c:if test="${blankRows gt 0}">
                    <c:forEach begin="0" end="${blankRows - 1}">
                        <tr class="${nearbySchoolClass}">
                            <td class="brdbtm_dotted-fff"><!-- do not collapse --></td>
                            <td class="brdbtm_dotted-fff"><!-- do not collapse --></td>
                            <td class="brdbtm_dotted-fff"><!-- do not collapse --></td>
                        </tr>
                    </c:forEach>
                </c:if>
                </tbody>
            </table>

        </c:otherwise>
        </c:choose>

        <div class="spacer_10"><!-- do not collapse --></div>

        <div id="nearby-schools-table-nav">

            <c:if test="${school.levelCode ne 'p'}">
                <div id="submitCompare" class="fltlft">
                    <button class="btn25-inactive fltlft" type="submit" name="compareBtn" id="compareBtn"
                            disabled="disabled">
                        <span class="lftDoor25"><span class="rtDoor25">Compare</span></span>
                        <br class="clearfloat"/>
                    </button>
                    <div class="submitCompareError smallAlertText fltlft"><!-- do not collapse --></div>
                </div>
            </c:if>

            <div class="pagination">
                <c:if test="${totalPages gt 1}">
                    <c:forEach begin="0" end="${rowsToDisplay - 1}" step="${pageSize}" var="i" varStatus="status">
                        <c:set var="pagerTabClass" value="pager-tab"/>
                        <c:set var="loopPageNumber" value="${i/pageSize+1}"/>
                        <c:if test="${loopPageNumber == thisPage}">
                            <c:set var="pagerTabClass" value="pager-tab active"/>
                        </c:if>
                        <c:if test="${status.first}">
                                <span class="${pagerTabClass}" onclick="page(${i});">
                                    <fmt:formatNumber value="${loopPageNumber}" maxFractionDigits="0"/>
                                </span>
                        </c:if>
                        <c:if test="${not status.first}">
                                <span class="${pagerTabClass}" onclick="page(${i})">
                                    <fmt:formatNumber value="${loopPageNumber}" maxFractionDigits="0"/>
                                </span>
                        </c:if>
                    </c:forEach>

                    <span class="prv_nxt">Next &amp;raquo;</span>
                </c:if>
            </div>

        </div>

        <script type="text/javascript">
            var PAGESIZE = ${pageSize};
            var currentStartPoint = null;
            function flipPage(startPoint) {
                currentStartPoint = startPoint;
                jQuery('#nearby-schools-table-body').find('.nearby-school').addClass("hidden");
                jQuery('#nearby-schools-table-body').find('.nearby-school').slice(startPoint, startPoint + PAGESIZE).removeClass("hidden");
            }

            function page(start) {
                var hasQueryParam = new RegExp('[\\?]').exec(window.location.href);
                var newHref = window.location.href;
                if (hasQueryParam) {
                    var startParam = new RegExp('start').exec(window.location.href);
                    if (startParam) {
                        newHref = newHref.replace(/(.+[\\?&amp;]start=)([^&amp;#]*)([^&amp;#]*)(.*)/, "$1" + start + "$3" + "#nearbySchoolsMap");
                    } else {
                        newHref = newHref.replace(/([^&amp;#]*)([^&amp;#]*)(.*)/, "$1" + "&amp;start=" + start + "$2" + "#nearbySchoolsMap");
                    }
                } else {
                    newHref = newHref.replace(/([^#]*)(.*)/, "$1" + "?start=" + start + "#nearbySchoolsMap");
                }
                window.location.href = newHref;
            }

            flipPage(${start});

            jQuery(function() {
                jQuery('.pager-tab').click(function() {
                    jQuery('.pager-tab').removeClass('active');
                    jQuery(this).addClass('active');
                });

                jQuery('.prv_nxt').click(function() {

                    var activeIndex = null;
                    var maxIndex = jQuery('.pager-tab').get().length;
                    jQuery('.pager-tab').each(function(index) {
                        if (jQuery(this).hasClass('active')) {
                            activeIndex = index;
                            activeIndex++;
                        }
                        if (activeIndex == maxIndex) {
                            activeIndex = 0;
                        }
                        currentStartPoint = activeIndex * PAGESIZE;
                    });

                    page(currentStartPoint);
                });
            });
        </script>

    </c:if>
    <!-- end nearby schools list-->


</jsp:root>