<?xml version="1.0" encoding="UTF-8"?>
<jsp:root version="2.0"
    xmlns:jsp="http://java.sun.com/JSP/Page"
    xmlns:link="urn:www.greatschools.org/taglib/link"
    xmlns:gsml="urn:jsptagdir:/WEB-INF/tags/gsml"
    xmlns:c="http://java.sun.com/jsp/jstl/core">
    <jsp:directive.tag import="gs.web.util.context.SessionContextUtil"/>
    <jsp:directive.tag import="gs.web.util.context.SessionContext"/>
    <jsp:directive.tag import="gs.data.util.CommunityUtil"/>
    <jsp:directive.tag import="gs.web.util.UrlUtil"/>
    <jsp:directive.tag body-content="scriptless"/>
    <!-- Required attributes -->
    <jsp:directive.attribute name="user" required="true" type="gs.data.community.User"
                             description="Member to output avatar for."/>
    <jsp:directive.attribute name="width" required="true" type="java.lang.Integer"
                             description="Width of avatar image."/>
    <jsp:directive.attribute name="height" required="true" type="java.lang.Integer"
                             description="Height of avatar image."/>
    <!-- Optional attributes -->
    <jsp:directive.attribute name="cssClass" required="false" type="java.lang.String"
                             description="CSS class for image."/>
    <jsp:directive.attribute name="cssId" required="false" type="java.lang.String"
                             description="CSS id for image."/>
    <jsp:directive.attribute name="cssStyle" required="false" type="java.lang.String"
                             description="CSS style."/>
    <jsp:directive.attribute name="alt" required="false" type="java.lang.String"
                             description="Optional alt tag (defaults to 'Avatar')."/>
    <jsp:directive.attribute name="anonymous" required="false" type="java.lang.Boolean"
                             description="If anonymous always use the default avatar."/>

    <jsp:scriptlet>
        SessionContext sessionContext = SessionContextUtil.getSessionContext(request);
        request.setAttribute("communityHost", sessionContext.getSessionContextUtil().getCommunityHost(request));

        request.setAttribute("avatarUrlPrefix", CommunityUtil.getAvatarURLPrefix());

        request.setAttribute("validAvatarSize", CommunityUtil.getClosestValidAvatarSize(width));

        if (UrlUtil.isDevEnvironment(request.getServerName()) &amp;&amp; (user == null || user.getUserProfile() == null)) {
            // error handling -- force anonymous avatar
            request.setAttribute("anonymous", "true");
        } else {
            request.setAttribute("avatarPath", CommunityUtil.getAvatarPath(user.getId()));
            request.setAttribute("avatarName", CommunityUtil.getAvatarFilename(user.getId(), width, "jpg"));
        }
    </jsp:scriptlet>


    <c:if test="${alt eq null}">
        <c:set var="alt" value="Avatar"/>
    </c:if>

    <c:if test="${empty anonymous}">
        <c:set var="anonymous" value="false"/>
    </c:if>

    <c:set var="avatarUrl" value="stock/default-${validAvatarSize}.jpg"/>
    <c:set var="avatarVersion" value=""/>
    <c:choose>
        <c:when test="${anonymous == true}">
            <!-- Do nothing, use the default which has already been set -->
        </c:when>
        <c:when test="${user.userProfile.avatarType eq 'custom'}">
            <c:set var="avatarUrl" value="${avatarPath}${avatarName}"/>
            <c:set var="avatarVersion" value="?v=${user.userProfile.avatarVersion}"/>
        </c:when>
        <!-- TODO gsweb tag to validate stock photos -->
        <c:when test="${user.userProfile.avatarType eq 'stk-sunflower' or
                        user.userProfile.avatarType eq 'stk-cat' or
                        user.userProfile.avatarType eq 'stk-dog' or
                        user.userProfile.avatarType eq 'stk-dandelion' or
                        user.userProfile.avatarType eq 'stk-palm'}">
            <c:set var="avatarUrl" value="stock/${user.userProfile.avatarType}-${validAvatarSize}.jpg"/>
        </c:when>
    </c:choose>

    <gsml:img src="${avatarUrlPrefix}${avatarUrl}${avatarVersion}"
              alt="${alt}" width="${width}" height="${height}"
              styleClass="${cssClass}" style="${cssStyle}"
              id="${cssId}"/>

</jsp:root>