<?xml version="1.0" encoding="UTF-8"?>
<jsp:root version="2.0"
          xmlns:jsp="http://java.sun.com/JSP/Page"
          xmlns:fn="http://java.sun.com/jsp/jstl/functions"
          xmlns:c="http://java.sun.com/jsp/jstl/core"
          xmlns:gsweb="gstaglib"
          xmlns:gsml="urn:jsptagdir:/WEB-INF/tags/gsml"
          xmlns:mod="urn:jsptagdir:/WEB-INF/tags/mod">
    <jsp:directive.tag import="gs.web.util.CookieUtil"/>
    <jsp:directive.tag import="org.apache.commons.lang.StringUtils"/>

    <jsp:directive.tag body-content="empty"/>

    <!-- writes out JS that requires the evaluation of JSTL expressions -->

    <script>
        var GS = GS || {};
        GS.properties = GS.properties || {};

        GS.properties.isDevEnvironment = ${requestScope.pageHelper.devEnvironment};

        GS.properties.jsLoggingEnabled = ('${param.jslogging}' === 'true');

        if (GS.properties.isDevEnvironment === true) {
            GS.sCodeModuleName = 'mobile/s_code_mobile';
        } else {
            GS.sCodeModuleName = 's_code';
        }

        GS.log = function() {
            if ('${param.jslogging}' === 'true') {
                console.log(arguments);
            }
        };

        GS.requireConfig = {
            baseUrl: '/res/js/mobile/',
            paths: {
                'sCode':'/res/js/' + GS.sCodeModuleName,
                'async':'/res/js/mobile/plugins/async',
                'order':'/res/js/mobile/plugins/order'
            },
            packages:["tracking"]
        };

    </script>

    <!-- Weinre (Web Inspector Remote) debugging for mobile pages -->
    <c:if test="${ requestScope.pageHelper.devEnvironment and !empty param.debug and param.debug }">
        <!-- get debug uuid from cookie or generate a new one -->
        <jsp:scriptlet>
            Cookie cookie = gs.web.util.CookieUtil.getCookie(request, "debugClient");
            if (cookie == null || org.apache.commons.lang.StringUtils.isBlank(cookie.getValue())) {
                request.setAttribute("debugClient", java.util.UUID.randomUUID().toString());
            } else {
                request.setAttribute("debugClient", cookie.getValue());
            }
        </jsp:scriptlet>

        <c:set var="address" value="debug.phonegap.com"/>
        <c:set var="port" value=""/>
        <c:set var="client" value="${debugClient}"/>

        <!-- override default values -->
        <c:if test="${!empty param.debugAddress}">
            <c:set var="address" value="${param.debugAddress}"/>
        </c:if>
        <c:if test="${!empty param.debugPort}">
            <c:set var="port" value=":${param.debugPort}"/>
        </c:if>
        <c:if test="${!empty param.debugClient}">
            <!-- reset uuid and update cookie -->
            <c:set var="client" value="${param.debugClient}"/>
        </c:if>

        <script type="text/javascript" src="http://${address}${port}/target/target-script-min.js#${client}"><!-- do not collapse --></script>
        <!-- write out to the console the debug uuid -->
        <script type="text/javascript"><![CDATA[
            document.cookie = 'debugClient=${client}; expires=Tue, 10 Aug 2022 20:47:11 UTC; path=/';
            $(document).ready(function(){
                $('body').append(
                    $('<a></a>').attr('href','http://${address}${port}/client/#${client}').html("web remote inspector (http://${address}${port}/client/#${client})"));
            });
        ]]>
        </script>
    </c:if>

</jsp:root>