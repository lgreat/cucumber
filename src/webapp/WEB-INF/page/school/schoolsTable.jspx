<?xml version="1.0" encoding="UTF-8"?>
<jsp:root xmlns:jsp="http://java.sun.com/JSP/Page" version="1.2"
          xmlns="http://www.w3.org/1999/xhtml"
          xmlns:c="http://java.sun.com/jsp/jstl/core"
          xmlns:fmt="http://java.sun.com/jsp/jstl/fmt"
          xmlns:fn="http://java.sun.com/jsp/jstl/functions"
          xmlns:spring="http://www.springframework.org/tags"
          xmlns:search="urn:jsptagdir:/WEB-INF/tags/search"
          xmlns:ad="urn:jsptagdir:/WEB-INF/tags/ad"
          xmlns:gsml="urn:jsptagdir:/WEB-INF/tags/gsml"
          xmlns:mod="urn:jsptagdir:/WEB-INF/tags/mod"
          xmlns:content="urn:jsptagdir:/WEB-INF/tags/content"
          xmlns:link="urn:www.greatschools.net/taglib/link"
          xmlns:promo="urn:jsptagdir:/WEB-INF/tags/promo"
          xmlns:school="urn:jsptagdir:/WEB-INF/tags/school"
          xmlns:map="urn:jsptagdir:/WEB-INF/tags/map"
          xmlns:pageHelper="urn:jsptagdir:/WEB-INF/tags/pageHelper"
          xmlns:gsweb="gstaglib">
<jsp:directive.page import="gs.data.school.LevelCode"/>
<jsp:directive.page import="gs.web.school.SchoolsController"/>
<jsp:directive.page import="gs.web.util.PageHelper"/>

<html lang="en">
<pageHelper:setPathway pathway="RESEARCH_COMPARE" />
<!-- Allow interstitials for this page.
     Note the property in the db must still be enabled for an interstitial to appear
     GS-3852 --> 
<c:if test="${requestScope.context.interstitialEnabled}">
    <pageHelper:externalJavascript file="/res/js/interstitial.js"/>
    <pageHelper:addOnLoadHandler handler="doInterstitial('search')"/>
</c:if>
<jsp:output doctype-root-element="html"
            doctype-public="-//W3C//DTD XHTML 1.0 Transitional//EN"
            doctype-system="http://www.w3c.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"/>

<jsp:directive.page contentType="text/html"/>

<pageHelper:externalJavascript file="/res/js/schoolsCompare.js"/>

<c:set var="cityName" value="${requestScope.cityName}"/>
<c:set var="district" value="${requestScope.district}"/>
<c:set var="cityDisplayName" value="${requestScope.cityDisplayName}"/>
<c:set var="districtObject" value="${requestScope.districtObject}"/>
<c:set var="heading1" value="${requestScope.heading1}"/>

<jsp:scriptlet>
    gs.web.util.PageHelper pageHelper = (PageHelper) request.getAttribute(PageHelper.REQUEST_ATTRIBUTE_NAME);
    if (null != pageHelper) {
        String city = request.getParameter("city");
        if (city != null) {
            pageHelper.addAdKeyword("city", city);
        }
    }
</jsp:scriptlet>

<head>
    <c:set var="title">
        <c:choose>
            <c:when test="${not empty cityDisplayName}">
                <jsp:scriptlet>
                    String title = SchoolsController.calcCitySchoolsTitle(
                            (String) request.getAttribute("cityDisplayName"),
                            (LevelCode) request.getAttribute("lc"),
                            request.getParameterValues("st"));
                    out.print(title);
                </jsp:scriptlet>
            </c:when>
            <c:when test="${not empty districtObject}">
                ${gsweb:districtPageTitle(districtObject)}
            </c:when>
            <c:otherwise>
                GreatSchools.net Search
            </c:otherwise>
        </c:choose>
    </c:set>

    <script language="JavaScript" type="text/javascript">
        <![CDATA[
        <!--
        var city = '${param.city}';
        var district = '${param.district}';
        var state = '${requestScope.context.stateOrDefault.abbreviation}';
        var levelCode = '${param.lc}';
        function reloadPageWithFilters() {
            var charterBox = document.getElementById('type_schools_charter');
            var publicBox = document.getElementById('type_schools_public');
            var privateBox = document.getElementById('type_schools_private');

            var reloadUrl = '/schools.page';
            if (city != '') {
                reloadUrl += '?city=' + city;
            } else {
                reloadUrl += '?district=' + district;
            }
            reloadUrl += '&state=' + state;
            if (levelCode.length > 0) {
                reloadUrl += '&lc=' + levelCode;
            }

            if (publicBox.checked) {
                reloadUrl += '&st=public';
            }
            if (charterBox.checked) {
                reloadUrl += '&st=charter';
            }
            if (privateBox.checked) {
                reloadUrl += '&st=private';
            }
            document.location = reloadUrl;
        }
        -->
        ]]>
    </script>

    <c:set var="metadesc">
        <c:choose>
            <c:when test="${not empty cityDisplayName}">

            <jsp:scriptlet>
                String metadesc = SchoolsController.calcMetaDesc(
                      (String)request.getAttribute("districtDisplayName"),
                      (String)request.getAttribute("cityDisplayName"),
                      (LevelCode)request.getAttribute("lc"),
                      request.getParameterValues("st"));
                out.print(metadesc);
            </jsp:scriptlet>
            </c:when>
            <c:when test="${not empty districtObject}">
                ${gsweb:districtPageDescription(districtObject)}
            </c:when>
        </c:choose>
    </c:set>

    <c:set var="metakey">
        <c:choose>
            <c:when test="${not empty districtObject}">
                ${gsweb:districtPageKeywords(districtObject)}
            </c:when>
        </c:choose>
    </c:set>

    <meta name="description" content="${metadesc}"/>
    <meta name="keywords" content="${metakey}"/>
    <title>${title}</title>

    <c:if test="${not requestScope.context.cobranded}">
        <style type="text/css">
            .pageWidth { width:100% !important; border:0}
        </style>
    </c:if>
    <c:if test="${requestScope.context.cobranded}">
        <style type="text/css">
            .rcopy { }
            .pageWidth { width:760px !important; border:0}
            #searchfooter { width: 400px !important;}
        </style>
    </c:if>

    <jsp:scriptlet>
        String[] sts = request.getParameterValues("st");
        String stOmniture = "";
        String pubCheckbox = "";
        String chaCheckbox = "";
        String priCheckbox = "";
        if (sts != null &amp;&amp; sts.length > 0) {
            for (String st: sts) {
                if ("public".equals(st)) {
                    request.setAttribute("publicChecked", "true");
                    stOmniture += ((stOmniture.length() > 0)?",":"") + "public";
                    chaCheckbox += ((stOmniture.length() > 0)?",":"") + "public";
                    priCheckbox += ((stOmniture.length() > 0)?",":"") + "public";
                } else if ("charter".equals(st)) {
                    request.setAttribute("charterChecked", "true");
                    stOmniture += ((stOmniture.length() > 0)?",":"") + "charter";
                    pubCheckbox += ((stOmniture.length() > 0)?",":"") + "charter";
                    priCheckbox += ((stOmniture.length() > 0)?",":"") + "charter";
                } else if ("private".equals(st)) {
                    request.setAttribute("privateChecked", "true");
                    stOmniture += ((stOmniture.length() > 0)?",":"") + "private";
                    pubCheckbox += ((stOmniture.length() > 0)?",":"") + "private";
                    chaCheckbox += ((stOmniture.length() > 0)?",":"") + "private";
                }
            }
        }
        if (request.getAttribute("publicChecked") == null) {
            pubCheckbox += ((stOmniture.length() > 0)?",":"") + "public";
        }
        if (request.getAttribute("charterChecked") == null) {
            chaCheckbox += ((stOmniture.length() > 0)?",":"") + "charter";
        }
        if (request.getAttribute("privateChecked") == null) {
            priCheckbox += ((stOmniture.length() > 0)?",":"") + "private";            
        }
        request.setAttribute("stOmniture", stOmniture);
        request.setAttribute("pubCheckbox", pubCheckbox);
        request.setAttribute("chaCheckbox", chaCheckbox);
        request.setAttribute("priCheckbox", priCheckbox);
    </jsp:scriptlet>
</head>

<gsml:body adPageName="search">
<c:set var="state" value="${requestScope.context.stateOrDefault}"/>
<pageHelper:externalCss file="/res/css/search/schoolResults.css"/>
<pageHelper:externalCss file="/res/css/brand.css"/>
<pageHelper:externalCss file="/res/css/school/schoolsTable.css"/>
<gsml:equalizeColumns ids="'col_left','col_right'"/>

<div id="col_left">
    <div id="resultsheader">
        <div id="rh_col_left">
            <span class="query">${heading1}</span>
        </div>
        <c:choose>
            <c:when test="${not empty param.city}">
                <link:city
                        city="${param.city}"
                        state="${state}"><span class="minilink">View city information</span></link:city>
            </c:when>
            <c:otherwise>
                <link:districtProfile
                        districtId="${param.district}"
                        state="${state}"><span class="minilink">View district information</span></link:districtProfile>
            </c:otherwise>
        </c:choose>
    </div>
    <c:if test="${not empty results.schools or not empty param.lc or not empty param.st}">
        <div id="resultsfilters">
            <div id="resultstabs" class="cleared">
                <!-- Figure out which tab is selected -->
                <c:set var="allTabClass" value=""/>
                <c:set var="pTabClass" value=""/>
                <c:set var="eTabClass" value=""/>
                <c:set var="mTabClass" value=""/>
                <c:set var="hTabClass" value=""/>
                <c:choose>
                    <c:when test="${param.lc eq 'p'}">
                        <c:set var="pTabClass" value="tabactive"/>
                    </c:when>
                    <c:when test="${param.lc eq 'e'}">
                        <c:set var="eTabClass" value="tabactive"/>
                    </c:when>
                    <c:when test="${param.lc eq 'm'}">
                        <c:set var="mTabClass" value="tabactive"/>
                    </c:when>
                    <c:when test="${param.lc eq 'h'}">
                        <c:set var="hTabClass" value="tabactive"/>
                    </c:when>
                    <c:otherwise>
                        <c:set var="allTabClass" value="tabactive"/>
                    </c:otherwise>
                </c:choose>
                <ul>
                    <li class="tableft ${allTabClass}">
                        <link:schools cityName="${cityName}"
                                      districtId="${district}"
                                      schoolType="${stOmniture}"
                                      styleClass="noInterstitial"
                                      showAll="${not empty param.showall}">All Schools</link:schools>
                    </li>
                    <!-- Commenting out preschool tab until preschools are live.
                         Uncommenting this block should be all that is required -->
                    <!-- TODO: comment out this link before 10.2 goes live -->
                    <li class="${pTabClass}">
                        <link:schools cityName="${cityName}"
                                      districtId="${district}"
                                      levelCode="p"
                                      styleClass="noInterstitial"
                                      showAll="${not empty param.showall}">Preschool</link:schools>
                    </li>
                    <li class="${eTabClass}">
                        <link:schools cityName="${cityName}"
                                      districtId="${district}"
                                      schoolType="${stOmniture}"
                                      levelCode="e"
                                      styleClass="noInterstitial"
                                      showAll="${not empty param.showall}">Elementary</link:schools>
                    </li>
                    <li class="${mTabClass}">
                        <link:schools cityName="${cityName}"
                                      districtId="${district}"
                                      schoolType="${stOmniture}"
                                      levelCode="m"
                                      styleClass="noInterstitial"
                                      showAll="${not empty param.showall}">Middle</link:schools>
                    </li>
                    <li class="tabright ${hTabClass}">
                        <link:schools cityName="${cityName}"
                                      districtId="${district}"
                                      schoolType="${stOmniture}"
                                      levelCode="h"
                                      styleClass="noInterstitial"
                                      showAll="${not empty param.showall}">High</link:schools>
                    </li>
                </ul>
            </div>
            <c:if test="${param.lc ne 'p'}">
                <form id="searchfilterform" action="" method="get">
                    <div>
                        <strong>Show me:</strong>
                        <label><gsml:checkbox name="type_schools[]"
                                              checked="${publicChecked}"
                                              styleId="type_schools_public"
                                              onclick="reloadPageWithFilters();"/><link:schools
                                cityName="${cityName}"
                                districtId="${district}"
                                schoolType="${pubCheckbox}"
                                levelCode="${param.lc}"
                                showAll="${not empty param.showall}"> Public</link:schools></label>
                        <label><gsml:checkbox name="type_schools[]"
                                              checked="${charterChecked}"
                                              styleId="type_schools_charter"
                                              onclick="reloadPageWithFilters();"/><link:schools
                                cityName="${cityName}"
                                districtId="${district}"
                                schoolType="${chaCheckbox}"
                                levelCode="${param.lc}"
                                showAll="${not empty param.showall}"> Charter</link:schools></label>
                        <label><gsml:checkbox name="type_schools[]"
                                              checked="${privateChecked}"
                                              styleId="type_schools_private"
                                              onclick="reloadPageWithFilters();"/><link:schools
                                cityName="${cityName}"
                                districtId="${district}"
                                schoolType="${priCheckbox}"
                                levelCode="${param.lc}"
                                showAll="${not empty param.showall}"> Private</link:schools></label>
                    </div>
                </form>
            </c:if>
        </div>
        <c:if test="${results.total gt 0}">
            <div id="resultspagination">
                    <c:set var="page" value="${(param.p > 0) ? (param.p-1) : 0}"/>
                    <c:set var="pageSize" value="${ (results.pageSize > 0) ? (results.pageSize) : 10}"/>
                    <c:set var="px" value="${(page * pageSize)}"/>
                    <strong>${px + 1} - ${(results.total lt px + pageSize) ? (results.total) : (px + pageSize)}</strong>
                    of <strong>${results.total}</strong>
                <c:if test="${results.total gt pageSize}">
                    <link:schools cityName="${cityName}" districtId="${district}"
                                  schoolType="${stOmniture}" levelCode="${param.lc}"
                                  styleClass="showAll" showAll="true"> Show All &gt;</link:schools>
                </c:if>
            </div>
        </c:if>
    </c:if>
    <div id="searchResults">
        <c:if test="${not empty results.schools}">
            <search:schoolTable schools="${results.schools}"/>
        </c:if>
        <c:if test="${empty results.schools and (not empty param.lc or not empty param.st)}">
            <div class="noResults">No filtered results in
                <c:choose>
                    <c:when test="${not empty param.city}">${param.city}</c:when>
                    <c:otherwise>${requestScope.distname}</c:otherwise>
                </c:choose>
            </div>
        </c:if>

        <search:schoolsPagination currentPage="${(empty param.p) ? 1 : param.p}" resultCount="${results.total}" pageSize="${pageSize}"/>

        <!-- typeOverride used in searchControl.tagx and/or mod:browseState -->
        <c:set var="typeOverride" value="school" scope="request"/>
        <div id="searchFooter" class="cleared">
            <c:choose>
                <c:when test="${not empty param.city}"><c:set var="queryText" value="${param.city}"/></c:when>
                <c:otherwise><c:set var="queryText" value="${requestScope.distname}"/></c:otherwise>
            </c:choose>

            <search:searchControl rememberQuery="true"
                                  showStates="true"
                                  showLinks="true"
                                  fieldLength="30"
                                  queryOverride="${queryText}"/>
        </div>
    </div>
</div>

<div id="col_right">
    <c:set var="slotPrefix" value="Search_Site"/>
    <c:if test="${not empty param.city}">
        <c:set var="slotPrefix" value="Search_All_Cities"/>
    </c:if>
    <ad:setSlotPrefix slotPrefix="${slotPrefix}"/>
    <c:choose>
        <c:when test="${not empty param.city}">
            <school:compareInCity city="${cityName}" state="${state}"/>
        </c:when>
        <c:otherwise>
            <school:compareInDistrict district="${district}" state="${state}"/>
        </c:otherwise>
    </c:choose>

    <!--<ad:Top_300x137/>-->
    <ad:AboveFold_300x600/>

    <c:if test="${requestScope.context.cobrand ne 'yahooed'}">
        <c:if test="${results.total gt 0}">
            <div id="mapContainer">
                <![CDATA[
                <script type="text/javascript">document.write('<div id="map" style="height: 400px; width: 100%">&#160;</div>')</script>
                ]]>
                <noscript>In order to view this map, enable JavaScript in your browser.</noscript>
            </div>
            <map:schools id="map"
                         bubbles="true"
                         schools="${results.schools}"/>
        </c:if>
    </c:if>

    <ad:multiTextAd blurb="Advertiser Links"/>
</div>

<br clear="left"/>

<c:if test="${not empty param.district}">
    <h1 id="sfooter" class="sfooter">${title}</h1>    
</c:if>

<c:choose>
    <c:when test="${not empty param.city}">
        <mod:tracking
                pageName="schools:city:${(empty results.showAll) ? ((empty param.p ? '1' : param.p)) : 'all'}${param.map eq 1 ? ':map':''}"
                hier1="Search,Schools,City,${(results.total gt 0 ? ((empty results.showAll) ? ((empty param.p ? '1' : param.p)) : 'all') : 'noresults') }"
                schoolType="${gsweb:toDelimitedString(paramValues.st)}"
                schoolLevel="${gsweb:toUglyDelimitedString(paramValues.gl)}"/>
    </c:when>
    <c:when test="${not empty param.district}">
        <mod:tracking
                pageName="schools:district:${(empty results.showAll) ? ((empty param.p ? '1' : param.p)) : 'all'}${param.map eq 1 ? ':map':''}"
                hier1="Search,Schools,District,${(results.total gt 0 ? ((empty results.showAll) ? ((empty param.p ? '1' : param.p)) : 'all') : 'noresults') }"
                schoolType="${gsweb:toDelimitedString(paramValues.st)}"
                schoolLevel="${gsweb:toUglyDelimitedString(paramValues.gl)}"/>
    </c:when>
    <c:otherwise>
        <mod:tracking pageName="schools${param.map eq 1 ? ':map':''}"
                      hier1="Search,Schools,Page${results.total gt 0 ? (empty param.p ? '1' : param.p) : 'noresults'}"
                      schoolType="${gsweb:toDelimitedString(paramValues.st)}"
                      schoolLevel="${gsweb:toUglyDelimitedString(paramValues.gl)}"/>

    </c:otherwise>
</c:choose>
</gsml:body>
</html>
</jsp:root>