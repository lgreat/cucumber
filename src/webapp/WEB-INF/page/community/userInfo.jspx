<?xml version="1.0" encoding="UTF-8"?>
<jsp:root xmlns:jsp="http://java.sun.com/JSP/Page"
          xmlns:gsml="urn:jsptagdir:/WEB-INF/tags/gsml"
          xmlns:c="http://java.sun.com/jsp/jstl/core"
          xmlns:fn="http://java.sun.com/jsp/jstl/functions"
          xmlns:fmt="http://java.sun.com/jsp/jstl/fmt"
          xmlns:spring="http://www.springframework.org/tags"
          xmlns:form="http://www.springframework.org/tags/form"
          xmlns:link="urn:www.greatschools.org/taglib/link"
          xmlns:mod="urn:jsptagdir:/WEB-INF/tags/mod"
          xmlns:pageHelper="urn:jsptagdir:/WEB-INF/tags/pageHelper"
          xmlns:community="urn:jsptagdir:/WEB-INF/tags/community"
          xmlns="http://www.w3.org/1999/xhtml" version="2.0"
          xmlns:ad="urn:jsptagdir:/WEB-INF/tags/ad"
          xmlns:gsweb="gstaglib"
          xmlns:cms="urn:jsptagdir:/WEB-INF/tags/content/cms">
<html lang="en">
<jsp:directive.page contentType="text/html"/>

<c:choose>
  <c:when test="${requestScope.pageType eq 'userAccount'}">
      <ad:setSlotPrefix slotPrefix="MyAccount"/>
  </c:when>
  <c:when test="${requestScope.pageType eq 'userProfile'}">
      <ad:setSlotPrefix slotPrefix="MemberProfile"/>
  </c:when>
</c:choose>

<head>
    <title>${requestScope.pageHeading} | GreatSchools</title>
    <meta name="keywords" content=""/>

    <script type="text/javascript">
        $(function() {

            // =========================================================================
            // about me
            // -------------------------------------------------------------------------

            function showAboutMeOnLoad(canEditBioText) {
                var bioText = $('.aboutMe .bioText');
                var defaultText = $('.aboutMe .defaultBioText');
                //alert('bioText: '+bioText);
                <![CDATA[
                if (bioText.text() == '' && canEditBioText) {
                    defaultText.show();
                    bioText.hide();                    
                } else {
                    defaultText.hide();
                    bioText.show();
                }
                return false;
                ]]>
            }

            //<c:if test = "${requestScope.canEditMember}" >

            function toggleAboutMe() {
                var bioText = $('.aboutMe .bioText');
                var defaultText = $('.aboutMe .defaultBioText');
                //alert('bioText: '+bioText+'  defaultText: '+defaultText);

                if ($('.aboutMe .bioText').is(':visible')) {
                    $('.aboutMe .defaultBioText').hide();
                    $('.aboutMe .bioText').hide();
                    $('.aboutMe #accountEditBio').show();
                    $('.aboutMe #accountEditBio').attr('style','display:block;');
                    $('.aboutMe .editAboutMe').hide();
                } else {
                    if ($('.aboutMe .bioText').text() == '') {
                        $('.aboutMe .defaultBioText').show();
                    }
                    $('.aboutMe .bioText').show();
                    $('.aboutMe #accountEditBio').hide();
                    $('.acommunityboutMe #accountEditBio').attr('style','display:none;');
                    $('.aboutMe .editAboutMe').show();                                        
                }
            }

            $('.aboutMe .editAboutMe, .aboutMe .editAboutMeSecondaryLink').click(function() {
                $('.aboutMe .bioInput').val($('.aboutMe .bioText').text());
                toggleAboutMe();
                return false;
            });

            $('.aboutMe .aboutMeSave').click(function() {
                $('.aboutMe .bioText').text($('.aboutMe .bioInput').val());
                var ajaxUrl = '/community/userAccountAjax.page';
                toggleAboutMe();
                $.post(ajaxUrl, {aboutMe:$('.aboutMe .bioInput').val(), memberId:$('.aboutMe .memberId').val()});
//                window.location.href=window.location.href;
//                window.location.reload();
                return false;
            });

            $('.aboutMe .aboutMeCancel').click(function() {
                toggleAboutMe();
                return false
            });

            //<c:if test="${empty pageUser.userProfile.aboutMe}">
            $('.defaultBioText').show();
            //</c:if>

            $('#resetPhotoLink').click(function() {
                var ajaxUrl = '/community/userAccountAjax.page';
                $.post(ajaxUrl, {resetPhoto:'true', memberId:$('.aboutMe .memberId').val()});
                window.location.reload();
                return false;
            });

            // =========================================================================

            //</c:if>

            //<c:if test = "${requestScope.canEditMember}" >

            $('#deactivateMember').click(function() {
                var ajaxUrl = '/community/userAccountAjax.page';
                $.post(ajaxUrl, {deactivateMember:'true', memberId:$('.aboutMe .memberId').val()},
                        function(data) {
                            window.location.reload();
                        });

                return false;
            });

            $('#reactivateMember').click(function() {
                var ajaxUrl = '/community/userAccountAjax.page';
                $.post(ajaxUrl, {reactivateMember:'true', memberId:$('.aboutMe .memberId').val()},
                        function(data) {
                            window.location.reload();
                        });
                return false;
            });

            //</c:if>
            showAboutMeOnLoad(${requestScope.canEditMember});

        });
    </script>

</head>
<body>
<div class="grid_16">

<div class="spacer_15"><!--do not collapse--></div>

<community:uploadAvatarHover openingElementSelector="#updateMyPhotoLink" redirect="${uri}"/>

<!-- Report it dialog -->
<community:reportContentHover openingElementSelector=".reportIt"
                              reporterId="${viewer.id}"/>
<!-- End report it dialog -->

<c:choose>
    <c:when test="${param.msg eq 'updatedPassword'}">
        <c:set var="message">Your password has been changed.</c:set>
    </c:when>
    <c:when test="${param.msg eq 'updatedSubscriptions'}">
        <c:set var="message">Your subscriptions have been updated.</c:set>
    </c:when>
</c:choose>

<c:if test="${not empty message}">

    <div id="acctCallToAction" class="mod">
        <div class="mod_bd">
            <p class="text2"><span class="alertDoubleArrow">&amp;raquo; </span>${message}</p>
        </div>
    </div>
    <!-- end acctCallToAction -->
    <div class="spacer_10"><!--do not collapse--></div>
</c:if>

<div id="userInfo" class="mod">
    <c:if test="${!requestScope.viewAllActivity}">
        <h2 class="fltlft">${requestScope.pageHeading}</h2>
        <c:if test="${requestScope.pageType eq 'userProfile' and !requestScope.viewingOwnProfile}">
            <c:choose>
                <c:when test="${requestScope.memberReport eq true}">
                    <span class="fltrt reported"><span class="sprite reportIt-nbg mrgrt_5"><!--icon--></span>You've reported this member.</span>
                </c:when>
                <c:otherwise>
                <span class="fltrt">
                    <span class="sprite reportIt-nbg mrgrt_5"><!--icon--></span><a id="report_member_${pageUser.id}"
                                                                                   class="reportIt"
                                                                                   href="${loginRedirectUrl}">Report this member
                    <span class="alertDoubleArrow">&amp;#187;</span></a>
                </span>
                </c:otherwise>
            </c:choose>
        </c:if>
        <c:if test="${requestScope.canBanMember}">
            <c:choose>
                <c:when test="${pageUser.userProfile.active}">
                <span class="fltrt">
                    <span class="sprite reportIt-nbg mrgrt_5"><!--icon--></span><a href="javascript:void(0);"
                                                                                   id="deactivateMember">Deactivate this member</a></span>
                </c:when>
                <c:otherwise>
                <span class="fltrt">
                    <span class="sprite reportIt-nbg mrgrt_5"><!--icon--></span><a href="javascript:void(0);"
                                                                                   id="reactivateMember">Reactivate this member</a>
                </span>
                </c:otherwise>
            </c:choose>
        </c:if>

        <br class="clearfloat"/>

        <c:choose>
            <c:when test="${avatarAlertType eq 'sync'}">
                <p class="smallAlertText">Your new avatar has been uploaded.</p>
            </c:when>
            <c:when test="${avatarAlertType eq 'async'}">
                <p class="smallAlertText">Your new avatar has been uploaded and should appear in a few minutes.</p>
            </c:when>
            <c:when test="${avatarAlertType eq 'error'}">
                <p class="smallAlertTextBold">We're sorry, there was an unexpected error uploading your new avatar.</p>
            </c:when>
        </c:choose>

        <div class="spacer_15"><!--do not collapse--></div>

        <div class="${requestScope.pageType eq 'userAccount' ? 'size63of100 col': 'size1of1'}">
            <div class="mod ${requestScope.pageType eq 'userAccount' ? 'padrt_15': ''}">
                <div class="avatar">
                    <community:avatar user="${requestScope.pageUser}" width="95" height="95" alt="User Avatar"/>

                    <p>
                        <c:choose>
                            <c:when test="${requestScope.viewingOwnProfile}">
                                <a href="javascript:void(0);" id="updateMyPhotoLink">Update my photo</a>
                            </c:when>
                            <c:when test="${requestScope.canEditMember and not empty requestScope.pageUser.userProfile.avatarType}">
                                <a href="javascript:void(0);" id="resetPhotoLink">Reset photo</a>
                            </c:when>
                        </c:choose>
                    </p>
                </div>
                <div class="aboutMe">
                    <p>Member since: <strong><fmt:formatDate value="${requestScope.pageUser.timeAdded}" type="date"
                                                             pattern="MMMM yyyy"/></strong></p>
                    <c:if test="${requestScope.viewingOwnProfile or not empty pageUser.userProfile.aboutMe}">
                        <p class="text1bold-d61">About me
                            <c:if test="${requestScope.canEditMember}">
                                <!--<span class="fltlt">-->
                                <a href="javascript:void(0);" class="editAboutMe">Edit</a>
                                <!--</span>-->
                            </c:if>
                        </p>
                    </c:if>

                    <p class="defaultBioText">Welcome to the GreatSchools community!
                        <a href="javascript:void(0);"
                           class="editAboutMeSecondaryLink">Tell us about yourself</a> to start building your profile.
                    </p>

                    <p class="bioText text3"><c:if
                            test="${not empty pageUser.userProfile.aboutMe}">${fn:escapeXml(pageUser.userProfile.aboutMe)}</c:if>
                    </p>

                    <div class="bioform">
                        <form action="/" id="accountEditBio" method="post">
                            <fieldset class="biodata">
                                <input type="hidden" name="memberId" class="memberId"
                                       value="${requestScope.pageUser.id}"/>
                                <textarea name="bio" class="bioInput" cols="0"
                                          rows="0"><!-- do not collapse --></textarea>
                            </fieldset>
                            <fieldset class="submit">

                                <button class="button-1 fltlft aboutMeSave" type="submit" name="Save" value="Save">Save</button>

                                <button class="button-1 fltlft aboutMeCancel" type="reset" name="Cancel" value="Cancel">Cancel</button>
                            </fieldset>
                        </form>
                    </div>
                </div>
            </div>

        </div>
        <c:if test="${requestScope.pageType eq 'userAccount'}">
            <div class="size37of100 col">
                <div class="mod myAccount brdlft_dotted">
                    <h4 class="subhead2">Manage my account</h4>
                    <ul class="text3-d61">
                        <li><link:changeEmail>Update my email address</link:changeEmail></li>
                        <li><link:resetPassword>Change my password</link:resetPassword></li>
                        <li><link:newsletterManagement>Manage emails &amp;amp; newsletters</link:newsletterManagement></li>
                        <li><link:mySchoolList>Edit My School List</link:mySchoolList></li>
                    </ul>
                </div>
            </div>
        </c:if>

        <c:if test="${requestScope.espDashboardAccess eq true}">
            <p class="clearLft ptm">
                <span class="sprite pencil_med"><!-- do not collapse --></span>
                <strong class="pls">
                    <c:choose>
                        <c:when test="${not empty requestScope.espFormSchool}">
                            <link:schoolEspDashboard>Edit the Official School Profile for ${requestScope.espFormSchool.name}</link:schoolEspDashboard>
                        </c:when>
                        <c:when test="${requestScope.espSuperUser eq true}">
                            <link:schoolEspDashboard>Edit Official School Profiles</link:schoolEspDashboard>
                        </c:when>
                        <c:otherwise>
                            <!-- Case for regular user with access to multiple schools -->
                            <link:schoolEspDashboard>Edit Official School Profiles</link:schoolEspDashboard>
                        </c:otherwise>
                    </c:choose>
                </strong>
            </p>
        </c:if>
    </c:if>

</div>
<!-- end userInfo -->
<div class="spacer_15"><!--do not collapse--></div>

<div id="userActivity" class="mod">
    <!-- Recent Activity -->
    <c:set var="recentActivityTitle">
        <c:choose>
            <c:when test="${requestScope.pageType eq 'userAccount'}">
                My recent activity
            </c:when>
            <c:otherwise>
                ${requestScope.pageUser.userProfile.screenName}'s recent activity
            </c:otherwise>
        </c:choose>
    </c:set>
<!--    <c:set var="myAccClass">
        <c:out value="${requestScope.pageType eq 'userAccount' and !requestScope.viewAllActivity ? ' col' : ''}"/>
    </c:set>-->

    <div class="${requestScope.pageType eq 'userAccount' ? 'size1of2 col': 'size1of1'}">
            <div class="mod ${requestScope.pageType eq 'userAccount' ? 'split': 'whole'} theActivities">


    <!--<div class="mod activity ${myAccClass}">-->
        <h4 class="subhead2 fltlft">${recentActivityTitle}</h4>
        <c:if test="${not empty requestScope.recentPosts}">
                <span class="fltrt">
                    <c:choose>
                        <c:when test="${requestScope.viewAllActivity}">
                            <a href="${requestScope.uri}">Return to
                                <c:choose>
                                    <c:when test="${requestScope.pageType eq 'userAccount'}">
                                        account <span class="alertDoubleArrow">&amp;#187;</span>
                                    </c:when>
                                    <c:otherwise>
                                        profile <span class="alertDoubleArrow">&amp;#187;</span>
                                    </c:otherwise>
                                </c:choose>
                            </a>
                        </c:when>
                        <c:otherwise>
                            <c:if test="${requestScope.showViewAllActivityLink}">
                                <a href="${requestScope.uri}?viewAllActivity=true">View all activity <span
                                        class="alertDoubleArrow">&amp;#187;</span></a>
                            </c:if>
                        </c:otherwise>
                    </c:choose>
                </span>
        </c:if>

        <br class="clearfloat"/>

        <c:choose>
            <c:when test="${empty requestScope.recentPosts}">
                <p>
                    <c:choose>
                        <c:when test="${requestScope.viewingOwnProfile}">You haven't</c:when>
                        <c:otherwise>${pageUser.userProfile.screenName} hasn't</c:otherwise>
                    </c:choose> posted anything yet.
                </p>
                <c:if test="${requestScope.viewingOwnProfile}">
                    <p>Share stories about your child's success in and out of the classroom in our community.</p>

                    <p>Our community wants to hear from you about:</p>
                    <ul class="prompt none">
                        <li><span><link:cmsContent contentKey="DiscussionBoard#1640"
                                                   fullUri="/parenting">Health &amp;amp; Development</link:cmsContent></span>
                        </li>
                        <li><span><link:cmsContent contentKey="DiscussionBoard#1641"
                                                   fullUri="/students">Academics &amp;amp; Activities</link:cmsContent></span>
                        </li>
                        <li><span><link:cmsContent contentKey="DiscussionBoard#1642"
                                                   fullUri="/special-education">Special Education</link:cmsContent></span>
                        </li>
                        <li><span><link:cmsContent contentKey="DiscussionBoard#1643"
                                                   fullUri="/improvement">Improving Schools</link:cmsContent></span>
                        </li>
                        <!-- li><span><link:discussion discussionId="1" fullUri="uri">Preparing for college</link:discussion></span></li -->
                    </ul>
                </c:if>
            </c:when>
            <c:otherwise>
                <ul class="activities none">
                    <c:forEach var="content" items="${requestScope.recentPosts}" varStatus="status">

                        <c:set var="numResults" value="${fn:length(requestScope.recentPosts)}"/>
                        <c:if test="${status.count le numResults}">

                                <!--<c:out value="${status.count}"/>-->
                                <!--<c:out value="${numResults}"/>-->

                                <c:choose>
                                    <c:when test="${status.count eq numResults}">
                                        <c:set var="className" value="lastone"/>
                                    </c:when>
                                    <c:otherwise>
                                        <c:set var="className" value=""/>
                                    </c:otherwise>
                                </c:choose>
                        </c:if>

                        <c:set var="supportedContentType" value="${true}"/>
                        <c:choose>
                            <c:when test="${content.type == 'Discussion'}">
                                <c:set var="discussion" value="${content}"/>
                                <c:set var="replyId" value="${null}"/>
                                <c:set var="introLabel" value="Started conversation"/>
                                <c:set var="discussionFullUri" value="${discussion.discussionBoard.fullUri}"/>
                            </c:when>
                            <c:when test="${content.type == 'DiscussionReply'}">
                                <c:set var="discussion" value="${content.discussion}"/>
                                <c:set var="replyId" value="${content.id}"/>
                                <c:set var="introLabel" value="Post in"/>
                                <c:set var="discussionFullUri" value="${discussion.discussionBoard.fullUri}"/>
                            </c:when>
                            <c:otherwise>
                                <c:set var="supportedContentType" value="${false}"/>
                            </c:otherwise>
                        </c:choose>

                        <c:if test="${supportedContentType}">

                            <li class="${className}">
                                <span class="sprite post fltlft"><!-- icon --></span>

                                <p class="text3bold">${introLabel}: <link:discussion discussionId="${discussion.id}"
                                                                                  fullUri="${discussionFullUri}"
                                                                                  discussionReplyId="${replyId}"
                                                                                  styleClass="text3">${discussion.title}</link:discussion>
                                    &amp;nbsp;<fmt:formatDate pattern="MMMMM d, yyyy" value="${content.dateCreated}"/>
                                </p>

                                <p>
                                    <community:userContentTeaserText
                                            textToDisplay="${content.body}"
                                            minLength="143" maxLength="163"
                                            discussionId="${discussion.id}"
                                            discussionReplyId="${replyId}"
                                            discussionFullUri="${discussionFullUri}"
                                            textSpanClass="text3"
                                            linkClass="smallText1"/>
                                </p>
                            </li>

                        </c:if>
                    </c:forEach>
                </ul>
                <c:if test="${requestScope.viewAllActivity}">
                    <community:pagination page="${requestScope.page}" totalPages="${requestScope.totalPages}"
                                          url="${uri}?viewAllActivity=true" styleClass="pagination"/>
                </c:if>
            </c:otherwise>
        </c:choose>
        <!-- End Recent Activity -->
    </div>
    </div>
    <c:if test="${!requestScope.viewAllActivity and requestScope.pageType eq 'userAccount'}">
        <jsp:include page="/mySchoolList.module"/>
    </c:if>

</div>
<!-- end mainContent -->
</div>

<cms:communitySidebar content="${requestScope.discussionBoard}" searchType="community"/>

<!-- end container -->
<mod:tracking pageName="${requestScope.omniturePagename}"
              hier1="${requestScope.omnitureHierarchy}"
              community="true"/>
</body>
</html>
</jsp:root>