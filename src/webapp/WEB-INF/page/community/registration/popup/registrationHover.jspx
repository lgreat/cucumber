<?xml version="1.0" encoding="UTF-8"?>
<jsp:root
        xmlns:jsp="http://java.sun.com/JSP/Page" version="1.2"
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:c="http://java.sun.com/jsp/jstl/core"
        xmlns:fmt="http://java.sun.com/jsp/jstl/fmt"
        xmlns:fn="http://java.sun.com/jsp/jstl/functions"
        xmlns:spring="http://www.springframework.org/tags"
        xmlns:gsml="urn:jsptagdir:/WEB-INF/tags/gsml"
        xmlns:mod="urn:jsptagdir:/WEB-INF/tags/mod"
        xmlns:pageHelper="urn:jsptagdir:/WEB-INF/tags/pageHelper"
        xmlns:gsweb="gstaglib"
        xmlns:link="urn:www.greatschools.net/taglib/link"
        xmlns:ad="urn:jsptagdir:/WEB-INF/tags/ad"
        >
<jsp:directive.page import="gs.web.community.registration.UserCommand"/>
<jsp:directive.page import="org.apache.commons.lang.StringUtils"/>
<jsp:directive.page import="java.net.URLEncoder"/>
<html lang="en">
<jsp:output doctype-root-element="html"
            doctype-public="-//W3C//DTD XHTML 1.0 Transitional//EN"
            doctype-system="http://www.w3c.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"/>

<jsp:directive.page contentType="text/html"/>
<pageHelper:setPathway pathway="COMMUNITY_LANDING"/>
<head>
    <![CDATA[
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
        ]]>
    <title>Join - GreatSchools</title>
    <pageHelper:externalJavascript file="/res/js/prototype.js"/>
    <pageHelper:externalCss file="/res/css/community/registration/popup/registrationHover.css"/>    
    <c:set var="nickname" value="${requestScope.context.nickname}"/>
    <c:if test="${nickname eq null or nickname eq ''}">
        <jsp:scriptlet>
            UserCommand userCmd = (UserCommand) request.getAttribute("userCmd");
            String nickname = userCmd.getEmail();
            if (StringUtils.contains(userCmd.getEmail(), '@')) {
                nickname = nickname.split("@")[0];
            }
            request.setAttribute("nickname", nickname);
        </jsp:scriptlet>
    </c:if>
    <jsp:scriptlet>
        UserCommand userCmd = (UserCommand) request.getAttribute("userCmd");
        String emailEscaped = userCmd.getEmail();
        if (StringUtils.isNotBlank(emailEscaped)) {
            emailEscaped = URLEncoder.encode(emailEscaped, "UTF-8");
        }
        request.setAttribute("emailEscaped", emailEscaped);
    </jsp:scriptlet>
    <script type="text/javascript">
        <![CDATA[
        <!--
        function stateChange(stateSelect) {
            var url = '/community/registrationAjax.page';
            var pars = 'state=' + stateSelect.value + "&type=city&showNotListed=true";
            $('city').innerHTML = '<select name="city" class="selectCity"><option value="">Loading ...</option></select>';
            var myAjax = new Ajax.Updater (
                    'city',
                    url,
                    {
                        method: 'get',
                        parameters: pars
                    });
        }

        function doSingleClick(element) {
            element.onclick = new Function('return false;');
            return true;
        }
        -->
        ]]>
    </script>
</head>

<gsml:body adPageName="registration">
    <div class="wrapper">
        <h2>Welcome to GreatSchools</h2>
        <div class="loginLink">
            Already a member?
            <a href="/community/registration/popup/loginOrRegisterHover.page?email=${emailEscaped}">Sign in</a>
        </div>

        <c:choose>
            <c:when test="${userCmd.mslOnly eq true}">
                <div class="infoMessage">
                    <img src="/res/img/community/registration/check.gif" alt="Check"/>
                    <p>
                        Hi, ${nickname}! You have an email address on file, but still need to create an
                        account with GreatSchools. Take a minute to register below!
                    </p>
                </div>
            </c:when>
            <c:otherwise>
                <p>
                    Choose the right school, find out what your child should be learning
                    grade-by-grade, track schools and more!
                </p>
            </c:otherwise>
        </c:choose>

        <form action="/community/registration/popup/registrationHover.page" method="post">
            <spring:bind path="userCmd.mslOnly">
                <input type="hidden" name="${status.expression}" value="${status.value}"/>
            </spring:bind>
            <spring:bind path="userCmd.how">
                <input type="hidden" name="${status.expression}" value="${status.value}"/>
            </spring:bind>
            <ul>
                <li id="emailLine">
                    <label for="email">Email address</label>
                    <spring:bind path="userCmd.user.email">
                        <input id="email" type="text" name="${status.expression}" value="${status.value}"/>
                    </spring:bind>
                    <gsml:errorMessage command="userCmd" field="email" useImage="true" styleClass="warning"/>
                </li>

                <li>
                    <label for="screenName">Username</label>
                    <spring:bind path="userCmd.screenName">
                        <input id="screenName" type="text" name="${status.expression}" value="${status.value}"/>
                    </spring:bind>
                    <gsml:errorMessage command="userCmd" field="screenName" useImage="true" styleClass="warning"/>
                    <span id="userDetails">6-14 characters</span>
                    <span id="userDisclaimer">Choose carefully&amp;#8212;This will be your public identity on GreatSchools</span>
                </li>

                <li>
                    <label for="password">Password</label>
                    <spring:bind path="userCmd.password">
                        <input id="password" type="password" name="${status.expression}" value=""/>
                    </spring:bind>
                    <gsml:errorMessage command="userCmd" field="password" useImage="true" styleClass="warning"/>
                    <span id="passwordDetails">6-14 characters</span>
                </li>

                <li>
                    <label for="confirmPassword">Re-type password</label>
                    <spring:bind path="userCmd.confirmPassword">
                        <input id="confirmPassword" type="password" name="${status.expression}" value=""/>
                    </spring:bind>
                    <gsml:errorMessage command="userCmd" field="confirmPassword" useImage="true" styleClass="warning"/>
                </li>

                <li id="whereLiveLine">
                    <label>Where do you live?</label>
                    <!-- State -->
                    <label id="stateLabel">State</label>
                    <spring:bind path="userCmd.state">
                        <gsweb:stateSelector state="${requestScope.context.stateOrDefault}" styleId="userState"
                                             onChange="stateChange(this);"/>
                    </spring:bind>
                    <gsml:errorMessage command="userCmd" field="state" useImage="true" styleClass="warning"/>

                    <!-- City -->
                    <label id="cityLabel">City</label>
                    <span id="city">
                        <select name="city">
                            <c:if test="${userCmd.cityList ne null and (userCmd.city eq null or userCmd.city eq '')}">
                                <option selected="selected" value="">Choose city</option>
                            </c:if>
                            <c:forEach var="cityOption" items="${userCmd.cityList}">
                                <![CDATA[<option ]]>
                                <c:if test="${userCmd.city eq cityOption.name}">
                                    selected="selected"
                                </c:if>
                                <![CDATA[ value="${cityOption.name}">${cityOption.name}</option>]]>
                            </c:forEach>
                        </select>
                    </span>
                    <gsml:errorMessage command="userCmd" field="city" useImage="true" styleClass="warning"/>
                </li>

                <li id="newsletter">
                    <gsml:checkbox styleId="newsletterField" styleClass="checkbox" name="newsletterStr"
                                   checked="${userCmd.newsletter eq true}"/>
                    <label for="newsletterField" class="checkbox">
                        Sign me up to receive expert tips and more in the free, bi-monthly Parent Advisor newsletter.
                    </label>
                </li>

                <c:set var="termsClass" value=""/>
                <spring:hasBindErrors name="userCmd">
                    <spring:bind path="userCmd.terms">
                        <c:if test="${status.errorMessage gt '' or status.errorCode gt ''}">
                            <c:set var="termsClass" value="withError"/>
                        </c:if>
                    </spring:bind>
                </spring:hasBindErrors>

                <li id="terms" class="${termsClass}">
                    <gsml:checkbox styleId="termsField" styleClass="checkbox" name="termsStr"
                                   checked="${userCmd.terms eq true}"/>
                    <label for="termsField" class="checkbox">I am over 13 years of age and I agree to the
                        <gsml:popupWindow width="800" height="600"
                                          title="GreatSchools Terms of Use"
                                          href="/cgi-bin/static/terms.html/$STATE"
                                          left="50" top="50">GreatSchools Terms of Use</gsml:popupWindow>,
                        including the
                        <gsml:popupWindow width="800" height="600"
                                          title="GreatSchools Community Standards"
                                          href="/cgi-bin/static/terms.html/$STATE#communityStandards"
                                          left="50" top="50">Community Guidelines</gsml:popupWindow>.
                    </label>
                    <gsml:errorMessage command="userCmd" field="terms" useImage="true" styleClass="warning"/>
                </li>
            </ul>

            <div class="privacyButtonBar">
                <span>
                    <gsml:popupWindow width="800" height="600"
                                      title="GreatSchools Privacy Policy"
                                      href="/about/privacyStatement.page?state=$STATE"
                                      left="50" top="50">GreatSchools Privacy Policy</gsml:popupWindow>
                </span>
                <gsml:inputImage src="/res/img/community/registration/join_large.gif" alt="Join"
                                 name="submit" onclick="return doSingleClick(this);"
                                 id="joinButton"/>
            </div>
        </form>
    </div>

    <div style="display: none;">
        <mod:tracking pageName="Registration Hover"
                      hier1="Account,Registration,Registration Hover"/>
    </div>
</gsml:body>
</html>
</jsp:root>