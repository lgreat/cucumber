<?xml version="1.0" encoding="UTF-8"?>
<jsp:root xmlns:jsp="http://java.sun.com/JSP/Page"
          xmlns="http://www.w3.org/1999/xhtml"
          xmlns:gsml="urn:jsptagdir:/WEB-INF/tags/gsml"
          xmlns:pageHelper="urn:jsptagdir:/WEB-INF/tags/pageHelper"
          version="2.0" >
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<jsp:directive.page contentType="text/html"/>
<jsp:output doctype-root-element="html"
            doctype-public="-//W3C//DTD XHTML 1.0 Transitional//EN"
            doctype-system="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"/>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>School Boundaries | GreatSchools</title>
    <style type="text/css">
        div.leftSide {
            width: 233px;
        }
        div.rightSide {
            width: 720px;
        }
        .searchLocationLabel {
            margin-left: 15px;
        }
        #districtListDiv {
            height: 350px;
            overflow-y: scroll;
            border: 1px solid;
            position: relative;
        }
        #districtList li {
            margin-bottom: 3px;
            list-style: disc inside;
            background-color: #ddd;
            font-size: 12px;
            padding: 1px;
        }
        #districtList li.selected {
            border: 1px solid red;
            padding: 0;
        }
        #schoolListDiv {
            height: 350px;
            overflow-y: scroll;
            border: 1px solid;
            position: relative;
        }
        #schoolList li {
            margin-bottom: 3px;
            list-style: disc inside;
            background-color: #ddd;
            font-size: 12px;
            padding: 1px;
        }
        #schoolList li.selected {
            border: 1px solid red;
            padding: 0;
        }
        #map-canvas{
            width:700px;
            height:500px;
            border:2px solid #999;
        }
    </style>

    <pageHelper:externalJavascript file="/res/js/history.min.js"/>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"><!-- no collapse --></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"><!-- no collapse --></script>

    <script type="text/javascript">
        <![CDATA[

        Array.prototype.contains = function(obj) {
          var i = this.length;
          while (i--) {
            if (this[i] === obj) {
              return true;
            }
          }
          return false;
        };
        var GS = GS || {};
        GS.Boundaries = GS.Boundaries || {};

        GS.Boundaries.BoundaryHelper = function() {
            var districtBoundaryMap;
            var polygons = new Array();
            var stuffOnMap = {};
            var selectedDistrict = null;
            var mapClickListeners = new Array();

            // DATA STRUCTURES
            var MarkerWithBoundary = function() {
                this.marker = null;
                this.polygon = null;
                this.state = null;
                this.id = null;
                this.name = null;
                this.rating = 0;
                this.showOnLoad = false;
                this.centerOnLoad = false;
                this.centroid = {};

                this.init = function(params) {
                    this.state = params.state;
                    this.id = params.id;
                    this.name = params.name;
                    if (typeof(params.rating) !== 'undefined') {
                        this.rating = params.rating;
                    }
                };
                this.isDistrict = function() {return false;};
                this.isSchool = function() {return false;};
                this.hasMarker = function() {
                    return this.marker != null;
                };
                this.isMarkerShown = function() {
                    return this.hasMarker() && this.marker.getMap() != null;
                };
                this.hideMarker = function() {
                    if (this.isMarkerShown()) {
                        this.marker.setMap(null);
                    }
                };
                this.showMarker = function() {
                    if (!this.isMarkerShown()) {
                        this.marker.setMap(districtBoundaryMap);
                    }
                };
                this.hasPolygon = function() {
                    return this.polygon != null;
                };
                this.isPolygonShown = function() {
                    return this.hasPolygon() && this.polygon.getMap() != null;
                };
                this.showPolygon = function() {
                    if (!this.isPolygonShown()) {
                        this.polygon.setMap(districtBoundaryMap);
                        this.showPolygonImpl();
                        updateDebugListeners(); // DEBUG
                    }
                };
                this.hidePolygon = function() {
                    if (this.isPolygonShown()) {
                        this.polygon.setMap(null);
                        this.hidePolygonImpl();
                    }
                };
                this.togglePolygon = function() {
                    if (this.isPolygonShown()) {
                        this.hidePolygon();
                    } else {
                        this.loadAndShowPolygon();
                    }
                };
                this.centerMap = function() {
                    if (typeof(this.centroid.lat) !== 'undefined' && typeof(this.centroid.lon) !== 'undefined') {
                        districtBoundaryMap.panTo(new google.maps.LatLng(this.centroid.lat, this.centroid.lon));
                    } else if (this.isMarkerShown()) {
                        districtBoundaryMap.panTo(this.marker.getPosition());
                    }
                }
            };
            var DistrictWithBoundary = function(params) {
                this.schools = new Array();

                this.init(params);
                this.loadSchools = function() {
                    if (!this.hasSchools()) {
                        getAllSchoolsForDistrictAjax(this.state, this.id, this.name);
                    } else {
                        this.showSchools();
                    }
                };
                this.hasSchools = function() {
                    return this.schools.length > 0;
                };
                this.showSchools = function() {
                    for (var x=0; x < this.schools.length; x++) {
                        this.schools[x].showMarker();
                    }
                    updateSchoolList();
                };
                this.hideSchools = function() {
                    for (var x=0; x < this.schools.length; x++) {
                        this.schools[x].hideMarker();
                    }
                };
                this.loadPolygon = function() {
                    if (!this.hasPolygon()) {
                        getDistrictBoundaryByIdAjax(this.state, this.id, this.name);
                    }
                };
                this.loadAndShowPolygon = function() {
                    if (!this.hasPolygon()) {
                        this.showOnLoad = true;
                        getDistrictBoundaryByIdAjax(this.state, this.id, this.name);
                    } else if (!this.isPolygonShown()) {
                        this.showPolygon();
                    }
                };
                this.showPolygonImpl = function() {
                    $('#' + this.getKey()).addClass("selected");
                    selectedDistrict = this;
                    $('#currentlySelectedDistrict').html(this.name);
                };
                this.hidePolygonImpl = function() {
                    $('#' + this.getKey()).removeClass("selected");
                    $('#currentlySelectedDistrict').html('');
                    selectedDistrict = null;
                    this.hideSchools();
                };
                this.getKey = function() {
                    return "district-" + this.state + "-" + this.id;
                };
                this.isDistrict = function() {return true;};
            };
            DistrictWithBoundary.prototype = new MarkerWithBoundary();
            var SchoolWithBoundary = function(params) {
                this.init(params);
                this.loadPolygon = function() {
                    if (this.hasPolygon()) {
                        this.showPolygon();
                    } else {
                        // ?
                    }
                };
                this.loadPolygon = function() {
                    if (!this.hasPolygon()) {
                        getSchoolBoundaryByIdAjax(this.state, this.id, this.name);
                    }
                };
                this.loadAndShowPolygon = function() {
                    if (!this.hasPolygon()) {
                        this.showOnLoad = true;
                        getSchoolBoundaryByIdAjax(this.state, this.id, this.name);
                    } else if (!this.isPolygonShown()) {
                        this.showPolygon();
                    }
                };
                this.showPolygonImpl = function() {
                    $('#' + this.getKey()).addClass("selected");
                };
                this.hidePolygonImpl = function() {
                    $('#' + this.getKey()).removeClass("selected");
                };
                this.getKey = function() {
                    return "school-" + this.state + "-" + this.id;
                };
                this.isSchool = function() {return true;};
            };
            SchoolWithBoundary.prototype = new MarkerWithBoundary();

            // AJAX METHODS
            var loadDistrictsServingLocationAjax = function(latitude, longitude) {
                jQuery.getJSON("/geo/boundary/ajax/getDistrictsForLocation.page", {lat:latitude, lon:longitude, level:$('.js_mapLevelCode:checked').val()}
                ).success(function(data) {
                    for (var districtIndex = 0; districtIndex < data.districts.length; districtIndex++) {
                        var district = data.districts[districtIndex];
                        var districtOnMap = getDistrictWithBoundary(district);
                        if (!districtOnMap.hasPolygon()) {
                            districtOnMap.polygon = createGoogleMapsPolygon({coordinates:district.coordinates, zIndex:1});
                        }
                        districtOnMap.showPolygon();
                        highlightPolygon(districtOnMap.polygon, 400);
                        if (typeof(district.centroid) !== 'undefined') {
                            districtOnMap.centroid = {lat: district.centroid.lat, lon: district.centroid.lon};
                        }
                    }
                    updateDistrictList();
                    if (data.districts.length == 0) {
                        alert("No district found at this point for level code " + $('.js_mapLevelCode:checked').val());
                    }
                }).error(function() {
                    alert("Error fetching districts for location: " + latitude + "," + longitude);
                });
            };
            var loadSchoolsServingLocationAjax = function(latitude, longitude) {
                jQuery.getJSON("/geo/boundary/ajax/getSchoolsForLocation.page", {lat:latitude, lon:longitude, level:$('.js_mapLevelCode:checked').val()}
                ).success(function(data) {
                    for (var schoolIndex = 0; schoolIndex < data.schools.length; schoolIndex++) {
                        var school = data.schools[schoolIndex];
                        var schoolOnMap = getSchoolWithBoundary(school);
                        if (schoolOnMap.isPolygonShown()) {
                            schoolOnMap.hidePolygon();
                        }
                        schoolOnMap.polygon = createGoogleMapsPolygon({coordinates:school.coordinates, strokeColor:'#78FF00', zIndex:2});
                        schoolOnMap.showPolygon();
                        highlightPolygon(schoolOnMap.polygon, 400);
                        if (typeof(school.centroid) !== 'undefined') {
                            schoolOnMap.centroid = {lat: school.centroid.lat, lon: school.centroid.lon};
                        }
                    }
                    updateSchoolList();
                    if (data.schools.length == 0) {
                        alert("No school found at this point for level code " + $('.js_mapLevelCode:checked').val());
                    }
                }).error(function() {
                    alert("Error fetching schools for location: " + latitude + "," + longitude);
                });
            };
            var getDistrictBoundaryByIdAjax = function(state, id, name) {
                jQuery.getJSON(
                        "/geo/boundary/ajax/getDistrictBoundary.page",
                        {state:state, id:id, level:$('.js_mapLevelCode:checked').val()}
                ).success(getDistrictBoundaryByIdSuccess
                ).error(function() {
                    alert("Error fetching district boundary: " + name + " (" + state + ":" + id + ")");
                });
            };
            var getSchoolBoundaryByIdAjax = function(state, id, name) {
                jQuery.getJSON(
                        "/geo/boundary/ajax/getSchoolBoundaryById.page",
                        {state:state, id:id, level:$('.js_mapLevelCode:checked').val()}
                ).success(getSchoolBoundaryByIdSuccess
                ).error(function(event) {
                    if (event.status == 404) {
                        alert("No school boundary found: " + name + " (" + state + ":" + id + ")");
                    } else {
                        alert("Error fetching school boundary: " + name + " (" + state + ":" + id + ")");
                    }
                });
            };
            var debug_getAllSchoolBoundariesForDistrictAjax = function(state, id, name) {
                jQuery.getJSON(
                        "/geo/boundary/ajax/getSchoolBoundariesForDistrict.page",
                        {state:state, districtId:id, level:$('.js_mapLevelCode:checked').val()}
                ).success(debug_getAllSchoolBoundariesForDistrictSuccess
                ).error(function() {
                    alert("Error fetching school boundaries for district: " + name + " (" + state + ":" + id + ")");
                });
            };
            var getAllSchoolsForDistrictAjax = function(state, id, name) {
                jQuery.getJSON(
                        "/geo/boundary/ajax/getSchoolsForDistrict.page",
                        {state:state, districtId:id, level:$('.js_mapLevelCode:checked').val()}
                ).success(getAllSchoolsForDistrictSuccess
                ).error(function() {
                    alert("Error fetching school list for district: " + name + " (" + state + ":" + id + ")");
                });
            };
            var loadDistrictsNearPointAjax = function(latitude, longitude) {
                if (typeof(window.History) !== 'undefined' && window.History.enabled === true) {
                    // use HTML 5 history API to rewrite the current URL to represent the new state.
                    window.History.replaceState(null, document.title, '?lat=' + latitude + '&lon=' + longitude);
                }
                jQuery.getJSON("/geo/boundary/ajax/getDistrictsNearPoint.page", {lat:latitude, lon:longitude, level:$('.js_mapLevelCode:checked').val()}
                ).success(function(data) {
                      try {
                          loadDistrictsNearPointSuccess(data.districts);
                          updateDistrictList();
                          districtBoundaryMap.panTo(new google.maps.LatLng(latitude, longitude));
                      } catch (e) {
                          alert("Error: "+ e.message);
                      }
                }).error(function() {
                    alert("Error fetching district list");
                });
            };
            // AJAX SUCCESS HANDLERS
            var loadDistrictsNearPointSuccess = function(districtList) {
                var mapBounds = new google.maps.LatLngBounds();
                var setBounds = false;
                clearMap();
                for (var districtIndex = 0; districtIndex < districtList.length; districtIndex++) {
                    var district = districtList[districtIndex];
                    var districtLatLng = new google.maps.LatLng(district.lat, district.lon);
                    if (districtBoundaryMap === undefined) {
                        initMap(districtLatLng);
                        setBounds = true;
                    }

                    var districtOnMap = getDistrictWithBoundary(district);
                    mapBounds.extend(districtOnMap.marker.getPosition());
                }
                if (setBounds) {
                    // only change zoom if it is the initial load
                    districtBoundaryMap.fitBounds(mapBounds);
                }
            };
            var getDistrictBoundaryByIdSuccess = function(data) {
                var districtOnMap = stuffOnMap["district-" + data.state + "-" + data.id];
                if (districtOnMap.isPolygonShown()) {
                    districtOnMap.hidePolygon()
                }
                districtOnMap.polygon = createGoogleMapsPolygon({coordinates:data.coordinates, zIndex:1});
                if (districtOnMap.showOnLoad === true) {
                    districtOnMap.showPolygon();
                }
                if (typeof(data.centroid) !== 'undefined') {
                    districtOnMap.centroid = {lat: data.centroid.lat, lon: data.centroid.lon};
                    if (districtOnMap.centerOnLoad === true) {
                        districtOnMap.centerMap();
                    }
                }
            };
            var getSchoolBoundaryByIdSuccess = function(data) {
                var schoolOnMap = stuffOnMap["school-" + data.state + "-" + data.id];
                if (schoolOnMap.isPolygonShown()) {
                    schoolOnMap.hidePolygon()
                }
                schoolOnMap.polygon = createGoogleMapsPolygon({coordinates:data.coordinates, strokeColor:'#78FF00', zIndex:2});
                if (schoolOnMap.showOnLoad === true) {
                    schoolOnMap.showPolygon();
                }
                if (typeof(data.centroid) !== 'undefined') {
                    schoolOnMap.centroid = {lat: data.centroid.lat, lon: data.centroid.lon};
                    if (schoolOnMap.centerOnLoad === true) {
                        schoolOnMap.centerMap();
                    }
                }
            };
            var debug_getAllSchoolBoundariesForDistrictSuccess = function(data) {
                if (data.schoolBoundaries.length == 0) {
                    alert("No school attendance zones found");
                }
                try {

                for (var x=0; x < data.schoolBoundaries.length; x++) {
                    var schoolBoundary = data.schoolBoundaries[x];
                    var key = "school-" + schoolBoundary.state + "-" + schoolBoundary.id;
                    if (typeof(stuffOnMap[key]) === 'undefined') {
                        stuffOnMap[key] = new SchoolWithBoundary({state:schoolBoundary.state, id:schoolBoundary.id, name:schoolBoundary.name, rating: schoolBoundary.rating});
                    } else {
                        console.log("Duplicate school key: " + key);
                        stuffOnMap[key].hidePolygon();
                    }
                    stuffOnMap[key].polygon = createGoogleMapsPolygon({coordinates:schoolBoundary.coordinates, strokeColor:'#78FF00', zIndex:2});
                    stuffOnMap[key].showPolygon();
                }
                } catch (e) {
                    alert("Error:" + e + "; " + e.message);
                }
            };
            var getAllSchoolsForDistrictSuccess = function(data) {
                if (data.schools.length == 0) {
                    alert("No schools found");
                }
                var districtKey = "district-" + data.state + "-" + data.districtId;
                var district = stuffOnMap[districtKey];
                for (var x=0; x < data.schools.length; x++) {
                    var school = data.schools[x];
                    var key = "school-" + school.state + "-" + school.id;
                    if (typeof(stuffOnMap[key]) === 'undefined') {
                        stuffOnMap[key] = new SchoolWithBoundary({state:school.state, id:school.id, name:school.name, rating: school.rating});
                    } else {
                        console.log("Duplicate school key: " + key);
                    }
                    var schoolMarker = createSchoolMarker(school);
                    schoolMarker.setMap(districtBoundaryMap);
                    stuffOnMap[key].marker = schoolMarker;
                    district.schools.push(stuffOnMap[key]);
                    google.maps.event.addListener(schoolMarker, 'click', createSchoolMarkerClickListener(stuffOnMap[key]));
                }
                updateSchoolList();
            };
            // MISCELLANEOUS FUNCTIONS
            var highlightPolygon = function(polygon, duration) {
                polygon.setOptions({strokeWeight:4});
                setTimeout(function() {
                    polygon.setOptions({strokeWeight:2});
                }, duration);
            };
            var initMap = function(center) {
                districtBoundaryMap = new google.maps.Map(document.getElementById('map-canvas'), {
                    zoom: 12,
                    center: center,
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                });
                $('.js_showWithMap').show();
            };
            var clearMap = function() {
                for (var key in stuffOnMap) {
                    var thingOnMap = stuffOnMap[key];
                    thingOnMap.hideMarker();
                    thingOnMap.hidePolygon();
                    delete stuffOnMap[key];
                }
                $('#districtList').empty();
                $('#schoolList').empty();
            };
            var clearPolygons = function() {
                for (var key in stuffOnMap) {
                    var thingOnMap = stuffOnMap[key];
                    thingOnMap.hidePolygon();
                }
            };
            var getUrlVars = function() {
                var vars = {};
                var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
                    vars[key] = value;
                });
                return vars;
            };
            var sortByGSRating = function(a,b) {
                if (a.rating > 0 && a.rating < 11 && b.rating > 0 && b.rating < 11) {
                    return b.rating - a.rating;
                } else if (a.rating > 0 && a.rating < 11) {
                    return -1;
                }
                return 1;
            };
            var browserGetLocationSuccess = function(pos) {
                var latitude = pos.coords.latitude;
                var longitude = pos.coords.longitude;
                loadDistrictsNearPointAjax(latitude, longitude);
            };
            var browserGetLocationFail = function() {
                loadDistrictsNearPointAjax(37.790948, -122.3942572);
            };
            var getDistrictWithBoundary = function(district) {
                var districtOnMap = stuffOnMap["district-" + district.state + "-" + district.id];
                if (typeof(districtOnMap) === 'undefined') {
                    districtOnMap = new DistrictWithBoundary({state:district.state, id:district.id, name:district.name, rating:district.rating});
                    districtOnMap.marker = createDistrictMarker(district);
                    google.maps.event.addListener(districtOnMap.marker, 'click', createDistrictMarkerClickListener(districtOnMap));
                    districtOnMap.showMarker();
                    stuffOnMap["district-" + district.state + "-" + district.id] = districtOnMap;
                }
                return districtOnMap;
            };
            var getSchoolWithBoundary = function(school) {
                var key = "school-" + school.state + "-" + school.id;
                var schoolOnMap = stuffOnMap[key];
                if (typeof(schoolOnMap) === 'undefined') {
                    schoolOnMap = new SchoolWithBoundary({state:school.state, id:school.id, name:school.name, rating:school.rating});
                    schoolOnMap.marker = createSchoolMarker(school);
                    google.maps.event.addListener(schoolOnMap.marker, 'click', createSchoolMarkerClickListener(schoolOnMap));
                    schoolOnMap.showMarker();
                    stuffOnMap[key] = schoolOnMap;

                    var districtKey = "district-" + school.state + "-" + school.districtId;
                    var district = stuffOnMap[districtKey];
                    if (typeof(district) !== 'undefined') {
                        district.schools.push(stuffOnMap[key]);
                    }
                }
                return schoolOnMap;
            };
            var hideAllPolygons = function() {
                for (var key in stuffOnMap) {
                    stuffOnMap[key].hidePolygon();
                }
            };
            var createDistrictMarker = function(district) {
                var icon = '/res/img/map/pushpin_na.png';
                if (district.rating > 0 && district.rating < 11) {
                    icon = '/res/img/map/pushpin_' + district.rating + '.png';
                }
                var markerImage = new google.maps.MarkerImage(icon, new google.maps.Size(40,40),
                                                              new google.maps.Point(0,0), new google.maps.Point(11,34));
                var markerShape = {
                    coord: [0, 0, 30, 0, 30, 37, 0, 37],
                    type: 'poly'
                };
                return new google.maps.Marker
                        ({
                             position: new google.maps.LatLng(district.lat, district.lon),
                             title:district.name,
                             icon:markerImage,
                             shape:markerShape
                         });
            };
            var createSchoolMarker = function(school) {
                var icon = '/res/img/map/GS_gsr_na_forground.png';
                if (school.rating > 0 && school.rating < 11) {
                    icon = '/res/img/map/GS_gsr_' + school.rating + '_forground.png';
                }
                var markerImage = new google.maps.MarkerImage(icon, new google.maps.Size(40,40),
                                                              new google.maps.Point(0,0), new google.maps.Point(11,34));
                var markerShadow = new google.maps.MarkerImage('/res/img/map/GS_gsr_1_backgroundshadow.png',
                                                               new google.maps.Size(40, 40),
                                                               new google.maps.Point(0, 0),
                                                               new google.maps.Point(11, 34));
                var markerShape = {
                    coord: [0, 0, 30, 0, 30, 37, 0, 37],
                    type: 'poly'
                };
                return new google.maps.Marker
                        ({
                             position: new google.maps.LatLng(school.lat, school.lon),
                             title:school.name,
                             icon:markerImage,
                             shadow:markerShadow,
                             shape:markerShape
                         });
            };
            var createGoogleMapsPolygon = function(options){ //zIndex, fillColor, strokeColor){
                var coords = options.coordinates;
                var zIndex = typeof(options.zIndex) !== 'undefined' ? options.zIndex : 1;
                var fillColor = typeof(options.fillColor) !== 'undefined' ? options.fillColor : '#46461F';
                var strokeColor = typeof(options.strokeColor) !== 'undefined' ? options.strokeColor : '#FF7800';
                var paths = [];
                for (var i=0;i < coords.length;i++){
                    for (var j=0;j<coords[i].length;j++){
                        var path=[];
                        for (var k=0;k<coords[i][j].length;k++){
                            var ll = new google.maps.LatLng(coords[i][j][k][1],coords[i][j][k][0]);
                            path.push(ll);
                        }
                        paths.push(path);
                    }
                }
                return new google.maps.Polygon({
                    paths: paths,
                    strokeColor: strokeColor,
                    strokeOpacity: 1,
                    strokeWeight: 2,
                    fillColor: fillColor,
                    fillOpacity: 0.25,
                    zIndex: zIndex
                });
            };

            // EVENT HANDLERS
            var createDistrictMarkerClickListener = function(districtOnMap) {
                return function() {
                    districtClickHandler({district:districtOnMap, center:false});
                };
            };
            var createSchoolMarkerClickListener = function(schoolOnMap) {
                return function() {
                    schoolClickHandler({school:schoolOnMap, center:false});
                };
            };
            var districtClickHandler = function(params) {
                var district = params.district;
                var moveToCenter = typeof(params.center) !== 'undefined' ? params.center : false;
                district.centerOnLoad = moveToCenter;
                if (!district.isPolygonShown()) {
                    hideAllPolygons();
                    district.loadAndShowPolygon();
                    district.loadSchools();
                }
                if (moveToCenter) {
                    district.centerMap();
                }
            };
            var schoolClickHandler = function(params) {
                var school = params.school;
                var moveToCenter = typeof(params.center) !== 'undefined' ? params.center : false;
                school.centerOnLoad = moveToCenter;
                if (!school.isPolygonShown()) {
                    if (school.hasPolygon() && moveToCenter) {
                        school.centerMap();
                    }
                    school.loadAndShowPolygon();
                } else {
                    school.hidePolygon();
                }
            };
            var loadDistrictsForLocationEventHandler = function(event) {
                if (event.latLng) {
                    loadDistrictsServingLocationAjax(event.latLng.lat(), event.latLng.lng());
                }
            };
            var loadSchoolsForLocationEventHandler = function(event) {
                if (event.latLng) {
                    loadSchoolsServingLocationAjax(event.latLng.lat(), event.latLng.lng());
                }
            };
            var updateDebugListeners = function() {
                for (var x=0; x < mapClickListeners.length; x++) {
                    google.maps.event.removeListener(mapClickListeners[x]);
                }
                mapClickListeners = new Array();
                var key;
                if ($('.js_mapClickBehavior:checked').val() == 'loadDistrict') {
                    mapClickListeners.push(google.maps.event.addListener(districtBoundaryMap, 'click', loadDistrictsForLocationEventHandler));
                    for (key in stuffOnMap) {
                        if (stuffOnMap[key].hasPolygon()) {
                            mapClickListeners.push(google.maps.event.addListener(stuffOnMap[key].polygon, 'click', loadDistrictsForLocationEventHandler));
                        }
                    }
                } else if ($('.js_mapClickBehavior:checked').val() == 'loadSchool') {
                    mapClickListeners.push(google.maps.event.addListener(districtBoundaryMap, 'click', loadSchoolsForLocationEventHandler));
                    for (key in stuffOnMap) {
                        if (stuffOnMap[key].hasPolygon()) {
                            mapClickListeners.push(google.maps.event.addListener(stuffOnMap[key].polygon, 'click', loadSchoolsForLocationEventHandler));
                        }
                    }
                }
            };
            var updateDistrictList = function() {
                var districtListDiv = $('#districtList');
                districtListDiv.empty();
                var districts = new Array();
                for (var key in stuffOnMap) {
                    if (key.indexOf('district') === 0) {
                        if (stuffOnMap[key].isMarkerShown()) {
                            districts.push(stuffOnMap[key]);
                        }
                    }
                }
                // sort on district rating
                districts.sort(sortByGSRating);
                for (var districtIndex = 0; districtIndex < districts.length; districtIndex++) {
                    var district = districts[districtIndex];
                    var districtKey = "district-" + district.state + "-" + district.id;
                    var districtRating = 'na';
                    var selected = '';
                    if (district.isPolygonShown()) {
                        selected = ' class="selected"';
                    }
                    var li = '<li id="' + districtKey + '"' + selected + '>' + district.name + ' ';
                    li += '<span class="sprite badge_sm_';
                    if (district.rating > 0 && district.rating < 11) {
                        li += district.rating
                    } else {
                        li += 'na'
                    }
                    li += '_b';
                    li += '"><!-- do not collapse --></span>';
                    li += '</li>';
                    districtListDiv.append(li);
                }
            };
            var updateSchoolList = function() {
                var schoolListDiv = $('#schoolList');
                schoolListDiv.empty();
                var schools = new Array();
                for (var key in stuffOnMap) {
                    if (key.indexOf('school') === 0) {
                        if (stuffOnMap[key].isMarkerShown()) {
                            schools.push(stuffOnMap[key]);
                        }
                    }
                }
                // sort on school rating
                schools.sort(sortByGSRating);
                for (var schoolIndex = 0; schoolIndex < schools.length; schoolIndex++) {
                    var school = schools[schoolIndex];
                    var schoolKey = "school-" + school.state + "-" + school.id;
                    var schoolRating = 'na';
                    var selected = '';
                    if (school.isPolygonShown()) {
                        selected = ' class="selected"';
                    }
                    var li = '<li id="' + schoolKey + '"' + selected + '>' + school.name + ' ';
                    li += '<span class="sprite badge_sm_';
                    if (school.rating > 0 && school.rating < 11) {
                        li += school.rating
                    } else {
                        li += 'na'
                    }
                    li += '_b';
                    li += '"><!-- do not collapse --></span>';
                    li += '</li>';
                    schoolListDiv.append(li);
                }
            };
            var geocodeAddress = function(searchInput, callbackFunc) {
                var geocoder = new google.maps.Geocoder();
                if (geocoder && searchInput) {
                    geocoder.geocode({ 'address': searchInput + ' US'}, function(results, status) {
                        var numResults = 0;
                        var GS_geocodeResults = new Array();
                        if (status == google.maps.GeocoderStatus.OK && results.length > 0) {
                            numResults = results.length;
                            for (var x = 0; x < numResults; x++) {
                                var geocodeResult = new Array();
                                geocodeResult['lat'] = results[x].geometry.location.lat();
                                geocodeResult['lon'] = results[x].geometry.location.lng();
                                geocodeResult['normalizedAddress'] =results[x].formatted_address;
                                geocodeResult['type'] = results[x].types.join();
                                if (results[x].partial_match) {
                                    geocodeResult['partial_match'] = true;
                                } else {
                                    geocodeResult['partial_match'] = false;
                                }
                                for (var i = 0; i < results[x].address_components.length; i++) {
                                    if (results[x].address_components[i].types.contains('administrative_area_level_1')) {
                                        geocodeResult['state'] = results[x].address_components[i].short_name;
                                    }
                                    if (results[x].address_components[i].types.contains('country')) {
                                        geocodeResult['country'] = results[x].address_components[i].short_name;
                                    }
                                }
                                // http://stackoverflow.com/questions/1098040/checking-if-an-associative-array-key-exists-in-javascript
                                if (!('lat' in geocodeResult && 'lon' in geocodeResult &&
                                        'state' in geocodeResult &&
                                        'normalizedAddress' in geocodeResult &&
                                        'country' in geocodeResult) ||
                                        geocodeResult['country'] != 'US') {
                                    geocodeResult = null;
                                }
                                if (geocodeResult != null) {
                                    GS_geocodeResults.push(geocodeResult);
                                }
                            }
                        }
                        callbackFunc(GS_geocodeResults);
                    });
                }
            };
            var geocodeAddressSuccess = function(geocodeResults) {
                if (geocodeResults.length == 0) {
                    alert("Cannot determine location for '" + searchInput + "'");
                } else if (geocodeResults.length == 1) {
                    geocodeResults[0]['totalResults'] = 1;
                    clearMap();
                    loadDistrictsNearPointAjax(geocodeResults[0]['lat'],
                                               geocodeResults[0]['lon']);
                    districtBoundaryMap.panTo(new google.maps.LatLng(geocodeResults[0]['lat'], geocodeResults[0]['lon']));
                } else {
                    // ignore multiple results for now
                    geocodeResults[0]['totalResults'] = geocodeResults.length;
                    clearMap();
                    loadDistrictsNearPointAjax(geocodeResults[0]['lat'],
                                               geocodeResults[0]['lon']);
                    districtBoundaryMap.panTo(new google.maps.LatLng(geocodeResults[0]['lat'], geocodeResults[0]['lon']));
                }
            };
            jQuery(function () {
                try {
                    var params = getUrlVars();
                    if (params.lat && params.lon) {
                        loadDistrictsNearPointAjax(params.lat, params.lon);
                    } else {
                        browserGetLocationFail();
                        navigator.geolocation.getCurrentPosition(browserGetLocationSuccess);
                    }
                } catch (e) {
                    browserGetLocationFail();
                }

                $('#js_reloadMap').click(function() {
                    clearMap();
                    loadDistrictsNearPointAjax(districtBoundaryMap.getCenter().lat(),
                                               districtBoundaryMap.getCenter().lng());
                });
                $('#js_clearPolygons').click(function() {
                    clearPolygons();
                });
                $('#js_clearAll').click(function() {
                    clearMap();
                });
                $('#js_drawAllDistricts').click(function() {
                    for (var key in stuffOnMap) {
                        stuffOnMap[key].loadAndShowPolygon();
                    }
                });
                $('#js_drawAllDistrictsAndSAZ').click(function() {
                    for (var key in stuffOnMap) {
                        if (key.indexOf('district') === 0) {
                            stuffOnMap[key].loadAndShowPolygon();
                            debug_getAllSchoolBoundariesForDistrictAjax(stuffOnMap[key].state, stuffOnMap[key].id, stuffOnMap[key].name);
                        }
                    }
                });
                $('#js_getSAZ').click(function() {
                    if (selectedDistrict != null) {
                        debug_getAllSchoolBoundariesForDistrictAjax(selectedDistrict.state, selectedDistrict.id, selectedDistrict.name);
                    }
                });
                $('.js_mapLevelCode').change(function() {
                    clearMap();
                    loadDistrictsNearPointAjax(districtBoundaryMap.getCenter().lat(),
                                    districtBoundaryMap.getCenter().lng());
                });
                $('.js_mapClickBehavior').change(updateDebugListeners);
                $('#districtList').delegate("li", "click", function() {
                    var key = $(this).attr('id');
                    if (stuffOnMap[key] !== undefined) {
                        districtClickHandler({district:stuffOnMap[key], center:true});
                    }
                });
                $('#schoolList').delegate("li", "click", function() {
                    var key = $(this).attr('id');
                    if (stuffOnMap[key] !== undefined) {
                        schoolClickHandler({school:stuffOnMap[key], center:true});
                    }
                });
                $('#js_loadAddress').click(function() {
                    geocodeAddress($('#js_mapAddressQuery').val(), geocodeAddressSuccess);
                });
            });
        };

        GS.Boundaries.boundaryHelper = new GS.Boundaries.BoundaryHelper();
        ]]>
    </script>

</head>
<gsml:body adPageName="districtBoundary" pageLayout="leftside">
    <div class="leftSide fltlft">
        <h3>School &amp; District Map Tool</h3>
        <div class="js_showWithMap hidden">
            <div id="districtListDiv">
                <ul id="districtList"><!-- not empty --></ul>
            </div>
            <div>Currently selected district: <span id="currentlySelectedDistrict"><!-- no collapse --></span></div>
            <div id="schoolListDiv">
                Schools:
                <ul id="schoolList"><!-- not empty --></ul>
            </div>
        </div>
    </div>
    <div class="rightSide fltrt">
        <div class="">
            <input type="radio" name="level_code" class="js_mapLevelCode" id="mapLevelCode_e" value="e" checked="checked"/><label for="mapLevelCode_e">Elementary</label>
            <input type="radio" name="level_code" class="js_mapLevelCode" id="mapLevelCode_m" value="m"/><label for="mapLevelCode_m">Middle</label>
            <input type="radio" name="level_code" class="js_mapLevelCode" id="mapLevelCode_h" value="h"/><label for="mapLevelCode_h">High</label>
            <label class="searchLocationLabel" for="js_mapAddressQuery">Search location:</label>
            <input type="text" name="addressQuery" id="js_mapAddressQuery"/>
            <button name="loadAddress" id="js_loadAddress">Search</button>
        </div>
        <div class="js_showWithMap hidden">
            <div id="map-canvas"><!-- no collapse --></div>
            <button name="reload" id="js_reloadMap">Reload at this location</button>
            <button name="clearAll" id="js_clearAll">Debug: Clear All</button>
            <button name="clearPolygons" id="js_clearPolygons">Debug: Clear Polygons</button>
            <button name="drawAllDistricts" id="js_drawAllDistricts" class="hidden">Debug: Draw all districts</button>
            <button name="getSAZ" id="js_getSAZ">Debug: Load SAZ for selected district</button>
            <button name="drawAllDistrictsAndSAZ" id="js_drawAllDistrictsAndSAZ" class="hidden">Debug: Draw all districts and SAZ (Warning!)</button>
            <div class="options">
                Map click behavior:
                <input type="radio" name="mapClickBehavior" class="js_mapClickBehavior" id="mapClickNothing" value="noop" checked="checked"/><label for="mapClickNothing">Nothing</label>
                <input type="radio" name="mapClickBehavior" class="js_mapClickBehavior" id="mapClickLoadDistrict" value="loadDistrict"/><label for="mapClickLoadDistrict">Show Containing District(s)</label>
                <input type="radio" name="mapClickBehavior" class="js_mapClickBehavior" id="mapClickLoadSchool" value="loadSchool"/><label for="mapClickLoadSchool">Show Containing School(s)</label>
            </div>
        </div>
    </div>
</gsml:body>
</html>
</jsp:root>