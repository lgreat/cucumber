<?xml version="1.0" encoding="UTF-8"?>
<jsp:root
        xmlns:jsp="http://java.sun.com/JSP/Page" version="1.2"
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:c="http://java.sun.com/jsp/jstl/core"
        xmlns:fn="http://java.sun.com/jsp/jstl/functions"
        xmlns:fmt="http://java.sun.com/jsp/jstl/fmt"
        xmlns:spring="http://www.springframework.org/tags"
        xmlns:gsml="urn:jsptagdir:/WEB-INF/tags/gsml"
        xmlns:ad="urn:jsptagdir:/WEB-INF/tags/ad"
        xmlns:promo="urn:jsptagdir:/WEB-INF/tags/promo"
        xmlns:search="urn:jsptagdir:/WEB-INF/tags/search"
        xmlns:mod="urn:jsptagdir:/WEB-INF/tags/mod"
        xmlns:map="urn:jsptagdir:/WEB-INF/tags/map"
        xmlns:pageHelper="urn:jsptagdir:/WEB-INF/tags/pageHelper"
        xmlns:link="urn:www.greatschools.net/taglib/link"
        xmlns:gsweb="gstaglib"
        >
<jsp:directive.page import="gs.web.util.PageHelper"/>
<html lang="en">
    <ad:setSlotPrefix slotPrefix="Nearby_Cities"/>
    <c:set var="stateAbbrev" value="${requestScope.context.stateOrDefault.abbreviation}"/>
    <jsp:output doctype-root-element="html"
                doctype-public="-//W3C//DTD XHTML 1.0 Transitional//EN"
                doctype-system="http://www.w3c.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"/>

    <jsp:directive.page contentType="text/html"/>

    <head>
        <![CDATA[
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
            ]]>
        <c:set var="city">${param["city"]}</c:set>
        <title>Select a City Near ${city}</title>

        <pageHelper:externalJavascript file="/res/js/prototype.js"/>

        <script type="text/javascript">
            <![CDATA[
            //<!--
            function verifyCity(selectId) {
                var citySelect = document.getElementById(selectId);
                if (citySelect.value == 'Choose city' || citySelect.value == '') {
                    alert("Please choose a city");
                    citySelect.focus();
                    return false;
                }
                return true;
            }

            function stateChange(stateSelect, cityDivId, citySelectId) {
                var url = 'citiesAjax.page';
                var pars = 'state=' + stateSelect.value;
                $(cityDivId).innerHTML = '<select name="city" id="' + citySelectId + '" class="compareCitySelect"><option value="">Loading ...</option></select>';
                new Ajax.Updater (
                        cityDivId,
                        url,
                        {
                            method: 'get',
                            parameters: pars
                        });
            }

            function openDefinition() {
                window.open("", "issues", 'width=400,height=300,scrollbars=yes');
            }

            var markers = {};
            var currentCity = null;
            function openInfoWindow(cityAndState, t) {
                var city = cityAndState.replace (/,...$/, '');
                if (currentCity != city) {
                    GEvent.trigger(markers[city], 'click');
                    currentCity = city;
                }
            }

            function closeInfoWindow(element, event, cityAndState) {
                var currentTarget = event.toElement || event.relatedTarget;
                if ((element != currentTarget) && !$(currentTarget).descendantOf(element) ) {
                    var city = cityAndState.replace (/,...$/, '');
                    if (currentCity == city) {
                        markers[city].closeInfoWindow();
                        currentCity = null;
                    }
                }
            }
            //-->
            ]]>
        </script>
        <jsp:scriptlet>
            try {
                PageHelper pageHelper = (PageHelper) request.getAttribute(PageHelper.REQUEST_ATTRIBUTE_NAME);
                String city = request.getParameter("city");
                if (null != pageHelper) {
                    pageHelper.addAdKeyword("city", city);
                }
            } catch (Exception e) { /* ignore */ }
        </jsp:scriptlet>
    </head>

    <gsml:body adPageName="city">
        <pageHelper:externalCss file="res/css/geo/cities.css"/>

        <div class="compareCitiesNear compareHorizontal">
            <gsweb:form id="compareHorizontal"
                        action="/cities.page"
                        method="get">
                <input type="hidden" name="includeState" value="${param['includeState']}"/>
                <input type="hidden" name="order" value="${param['order']}"/>
                <input type="hidden" name="all" value="${param['all']}"/>
                <gsml:img src="/res/img/geo/compare_yellow.gif"
                          alt="Magnifying glass"/>
                <h2>Compare cities near:</h2>
                <div id="horizontalCompareCity">
                    <select id="horizontalCompareCitySelect" name="city" class="compareCitySelect">
                        <c:forEach var="cityOption" items="${requestScope.compareCities}">
                            <gsml:selectOption selected="${requestScope.cityObject.name eq cityOption.name}"
                                               value="${cityOption.name}"
                                >${cityOption.name}</gsml:selectOption>
                        </c:forEach>
                    </select>
                </div>
                <gsweb:stateSelector state="${param['state']}"
                                     styleId="horizontalCompareState"
                                     name="state"
                                     onChange="stateChange(this, 'horizontalCompareCity', 'horizontalCompareCitySelect');"/>

                <gsml:inputImage src="/res/img/button/go.gif" alt="Go"
                                 name="submit" onclick="return verifyCity('horizontalCompareCitySelect');"/>
            </gsweb:form>
        </div>

        <table width="100%" cellpadding="0" cellspacing="0">
            <tr>
                <td style="width:290px; vertical-align: top">
                    <div id="nearbyCities">
                        <ul>
                            <c:forEach var="anchor" items="${requestScope.anchorListModel.results}" varStatus="count">
                                <c:set var="listItemClass" value="${anchor.styleClass}"/>
                                <c:if test="${anchor eq requestScope.anchorListModel.results[0]}">
                                    <c:set var="listItemClass" value="${anchor.styleClass} first"/>
                                </c:if>
                                <li class="${listItemClass} foo"
                                    onmouseover="openInfoWindow('${anchor.contents}')"
                                    onmouseout="closeInfoWindow(this, event, '${anchor.contents}')">
                                    <a href="${anchor.hrefXml}">${anchor.contents}
                                        <c:if test="${not empty anchor.after}">
                                            <c:set var="imageValue" value="${anchor.after}"/>
                                            <c:set var="imageAlt" value="GreatSchools Rating: ${imageValue} out of 10. GreatSchools Ratings are based on test results. 10 is best."/>
                                            <c:if test="${imageValue eq '0'}">
                                                <c:set var="imageValue" value="na"/>
                                                <c:set var="imageAlt" value="GreatSchools Rating: no rating available. GreatSchools Ratings are based on test results. 10 is best."/>
                                            </c:if>
                                            <gsml:img src="/res/img/geo/ratings/cities_sm_${imageValue}.gif" alt="${imageAlt}"/>
                                        </c:if>
                                    </a>
                                </li>
                            </c:forEach>
                        </ul>
                    </div>
                </td>
                <c:if test="${requestScope.context.cobrand ne 'yahooed'}">
                    <td style="vertical-align: top">
                        <div id="mapContainer">
                            <div id="map">&#160;</div>
                            <noscript>In order to view this map, enable JavaScript in your browser.</noscript>
                        </div>
                        <map:setup/>
                        <map:citiesWithRatings functionName="createMap"
                                               id="map"
                                               lon="${requestScope.cityObject.lon}"
                                               lat="${requestScope.cityObject.lat}"
                                               scale="7"
                                               cities="${requestScope.cities}"/>
                        <pageHelper:addOnLoadHandler handler="createMap()"/>
                        <br/>
                        <div class="learnMore">
                            <gsweb:articlelink
                                    articleId="1023"
                                    anchorName="13">Learn more about GreatSchools City Ratings &gt;</gsweb:articlelink>
                        </div>
                    </td>
                </c:if>
            </tr>
            <tr>
                <td>&amp;nbsp;</td>
                <td>
                    <c:if test="${requestScope.context.cobrand ne 'yahooed'}">
                        <div class="reference">
                            <div class="bpReference">
                                Median home price data provided by <a href="http://www.bestplaces.net" target="_blank">Sperling's Best Places</a>
                            </div>
                            <gsml:a href="/definitions/natl/median_home_price.html" target="issues" onClick="openDefinition();" title="Information about this data">
                                <img src="/res/img/yellow_circle_i.gif" alt="yellow i in circle" />
                            </gsml:a>
                        </div>
                    </c:if>
                </td>
            </tr>
            </table>

        <div id="editorialBar">
            <div class="compareCitiesNear compareVertical">
                <gsweb:form id="compareVertical"
                            action="/cities.page"
                            method="get">
                    <input type="hidden" name="includeState" value="${param['includeState']}"/>
                    <input type="hidden" name="order" value="${param['order']}"/>
                    <input type="hidden" name="all" value="${param['all']}"/>
                    <gsml:img src="/res/img/geo/compare_yellow.gif"
                              alt="Magnifying glass"/>
                    <h2>Compare cities near:</h2>
                    <div id="verticalCompareCity">
                        <select id="verticalCompareCitySelect" name="city" class="compareCitySelect">
                            <c:forEach var="cityOption" items="${requestScope.compareCities}">
                                <gsml:selectOption selected="${requestScope.cityObject.name eq cityOption.name}"
                                                   value="${cityOption.name}"
                                    >${cityOption.name}</gsml:selectOption>
                            </c:forEach>
                        </select>
                    </div>
                    <gsweb:stateSelector state="${param['state']}"
                                         styleId="verticalCompareState"
                                         name="state"
                                         onChange="stateChange(this, 'verticalCompareCity', 'verticalCompareCitySelect');"/>

                    <gsml:inputImage src="/res/img/button/go.gif" alt="Go"
                                     name="submit" onclick="return verifyCity('verticalCompareCitySelect');"/>
                </gsweb:form>
            </div>

            <div class="editorialMoving">
                <link:movingWithKids>
                    <gsml:img src="/res/img/content/movingWithKids/movingWithText.jpg"
                              alt="Moving? View our tips to help your child with the transition"/>
                </link:movingWithKids>
            </div>

            <div class="editorialChoosing">
                <link:schoolChoiceCenter>
                    <gsml:img src="/res/img/content/schoolChoiceTips/sctWithText.jpg"
                              alt="Choosing a school? Check out our school choice tips"/>
                </link:schoolChoiceCenter>
            </div>
        </div>

        <mod:tracking pageName="Nearby Cities"
                      locale="${city}"
                      hier1="Home,City Home,Nearby Cities"/>

    </gsml:body>

    </html>
</jsp:root>