<?xml version="1.0" encoding="UTF-8"?>
<!--
/*
* Copyright 2005 GreatSchools.net. All Rights Reserved.

 */
 -->

<project xmlns:j="jelly:core" xmlns:ant="jelly:ant" default="war">

    <preGoal name="java:compile">
        <mkdir dir="${maven.war.webapp.dir}/WEB-INF"/>
        <!-- <attainGoal name="xdoclet2:run"/> -->
        <attainGoal name="create-build-version"/>
    </preGoal>

    <!-- Copy the Spring XML config files to the test dir for BaseTestCase -->
    <preGoal name="test:test">
        <copy todir="${maven.test.dest}">
            <fileset dir="${maven.src.dir}/webapp/WEB-INF">
                <include name="**/*.xml"/>
            </fileset>
        </copy>
    </preGoal>

    <!-- Delete the webapp dirs explicitly since some deploy under src/webapp/WEB-INF -->
    <preGoal name="clean:clean">
        <delete dir="${maven.src.dir}/webapp/WEB-INF/lib"/>
        <delete dir="${maven.src.dir}/webapp/WEB-INF/classes"/>
        <delete dir="${maven.war.webapp.dir}/webapp/WEB-INF/classes"/>
    </preGoal>

    <preGoal name="war:war">
        <!-- GWT specifies war:webapp as a prereq which results in unit tests getting run twice -->
        <j:set var="maven.test.skip.backup" value="${maven.test.skip}"/>
        <j:set var="maven.test.skip" value="true"/>
        <attainGoal name="gwt:compile"/>
        <j:set var="maven.test.skip" value="${maven.test.skip.backup}"/>
    </preGoal>

    <!-- Create a version.properties file with the build info -->
    <goal name="create-build-version">
        <ant:propertyfile file="${maven.build.dest}/version.properties">
            <entry key="gsweb.buildtime"
                   type="date"
                   default="now"
                   pattern="yyyyMMddkkmmss"/>
            <entry key="gsweb.version"
                   type="string"
                   default="${pom.currentVersion}"/>
        </ant:propertyfile>
    </goal>

    <goal name="cruisecontrol">
        <attainGoal name="clean"/>
        <j:set var="maven.test.skip" value="true"/>
        <attainGoal name="war"/>
        <j:set var="maven.test.skip" value="false"/>
        <attainGoal name="test"/>
        <!-- avoid running tests again -->
        <j:if test="${maven.test.failure}">
            <fail message="There were test failures."/>
        </j:if>
    </goal>

    <!-- This report is run nightly by conint to generate web documentation -->
    <goal name="webdocs">
        <attainGoal name="clean"/>
        <attainGoal name="clover:on"/>
        <attainGoal name="site"/>
    </goal>
</project>

